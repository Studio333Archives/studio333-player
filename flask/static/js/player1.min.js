const DEBUG_GUI_SYNC=!0,STORAGE_KEY="blobPlayerState.v1";function log(...e){console.debug("[GUI]",...e)}import*as THREE from"three";import{OrbitControls}from"three/addons/controls/OrbitControls.js";import{GUI}from"lil-gui";import{SimplexNoise}from"three/addons/math/SimplexNoise.js";const container=document.getElementById("app"),renderer=new THREE.WebGLRenderer({antialias:!0,powerPreference:"high-performance"});renderer.setPixelRatio(Math.min(devicePixelRatio,2)),renderer.setSize(container.clientWidth,container.clientHeight),renderer.setClearColor(0,1),renderer.outputColorSpace=THREE.SRGBColorSpace,renderer.physicallyCorrectLights=!0,container.appendChild(renderer.domElement);const scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(50,container.clientWidth/container.clientHeight,.1,3e4);camera.position.set(0,1.6,3.5),scene.add(new THREE.AmbientLight(16777215,.02));const rim=new THREE.DirectionalLight(16777215,.18);rim.position.set(-3,2,-2),scene.add(rim);const pool=new THREE.SpotLight(16737996,4,3.2,.18*Math.PI,.55,2);pool.position.set(0,1.6,0),pool.target.position.set(0,0,0),scene.add(pool,pool.target);const fadeGeo=new THREE.PlaneGeometry(40,40),fadeMat=new THREE.ShaderMaterial({transparent:!0,depthWrite:!1,uniforms:{uRadius:{value:1.6},uSoft:{value:1.2}},vertexShader:"varying vec2 vXZ; void main(){ vec4 wp = modelMatrix * vec4(position,1.0); vXZ = wp.xz; gl_Position = projectionMatrix * viewMatrix * wp; }",fragmentShader:"precision highp float; uniform float uRadius,uSoft; varying vec2 vXZ; void main(){ float r=length(vXZ); float a=smoothstep(uRadius,uRadius+uSoft,r); gl_FragColor=vec4(0.,0.,0.,a); }"}),fade=new THREE.Mesh(fadeGeo,fadeMat);fade.rotation.x=.5*-Math.PI,fade.position.y=5e-4,scene.add(fade);const simplexGLSL="\n      vec3 mod289(vec3 x){ return x - floor(x * (1.0 / 289.0)) * 289.0; }\n      vec4 mod289(vec4 x){ return x - floor(x * (1.0 / 289.0)) * 289.0; }\n      vec4 permute(vec4 x){ return mod289(((x*34.0)+1.0)*x); }\n      vec4 taylorInvSqrt(vec4 r){ return 1.79284291400159 - 0.85373472095314 * r; }\n      float snoise(vec3 v){\n        const vec2  C = vec2(1.0/6.0, 1.0/3.0);\n        const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);\n        vec3 i  = floor(v + dot(v, C.yyy));\n        vec3 x0 = v - i + dot(i, C.xxx);\n        vec3 g = step(x0.yzx, x0.xyz);\n        vec3 l = 1.0 - g;\n        vec3 i1 = min(g.xyz, l.zxy);\n        vec3 i2 = max(g.xyz, l.zxy);\n        vec3 x1 = x0 - i1 + C.xxx;\n        vec3 x2 = x0 - i2 + 2.0*C.xxx;\n        vec3 x3 = x0 - 1.0 + 3.0*C.xxx;\n        i = mod289(i);\n        vec4 p = permute( permute( permute(\n                  i.z + vec4(0.0, i1.z, i2.z, 1.0))\n                + i.y + vec4(0.0, i1.y, i2.y, 1.0))\n                + i.x + vec4(0.0, i1.x, i2.x, 1.0));\n        float n_ = 1.0/7.0;\n        vec3  ns = n_ * D.wyz - D.xzx;\n        vec4 j = p - 49.0 * floor(p * ns.z * ns.z);\n        vec4 x_ = floor(j * ns.z);\n        vec4 y_ = floor(j - 7.0 * x_);\n        vec4 x = x_ *ns.x + ns.yyyy;\n        vec4 y = y_ *ns.x + ns.yyyy;\n        vec4 h = 1.0 - abs(x) - abs(y);\n        vec4 b0 = vec4( x.xy, y.xy );\n        vec4 b1 = vec4( x.zw, y.zw );\n        vec4 s0 = floor(b0)*2.0 + 1.0;\n        vec4 s1 = floor(b1)*2.0 + 1.0;\n        vec4 sh = -step(h, vec4(0.0));\n        vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy;\n        vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww;\n        vec3 p0 = vec3(a0.xy,h.x);\n        vec3 p1 = vec3(a0.zw,h.y);\n        vec3 p2 = vec3(a1.xy,h.z);\n        vec3 p3 = vec3(a1.zw,h.w);\n        vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2,p2), dot(p3,p3)));\n        p0 *= norm.x; p1 *= norm.y; p2 *= norm.z; p3 *= norm.w;\n        vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);\n        m = m*m;\n        return 42.0 * dot(m*m, vec4(dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,p3)));\n  }",uiPanel=document.getElementById("ui"),webcamBtn=document.getElementById("webcamBtn"),imgInput=document.getElementById("imgInput"),vidInput=document.getElementById("vidInput"),audioInput=document.getElementById("audioInput"),clearBtn=document.getElementById("clearBtn"),startBtn=document.getElementById("startBtn"),prevBtn=document.getElementById("prevBtn"),nextBtn=document.getElementById("nextBtn"),loopChk=document.getElementById("loopChk"),playlistSelect=document.getElementById("playlistSelect");let uiVisible=!1;function applyUIVisibility(){uiPanel.style.display=uiVisible?"flex":"none";const e=document.querySelector(".lil-gui.root");e&&(e.style.display=uiVisible?"":"none")}const searchBtn=document.getElementById("searchToggle"),searchBox=document.getElementById("searchPanel"),playlistSel=document.getElementById("playlistSelect");let __wasUiVisible=null,__wasSearchOpen=!1;function isFs(){return!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)}function enterFs(){const e=document.documentElement;(e.requestFullscreen||e.webkitRequestFullscreen||e.mozRequestFullScreen||e.msRequestFullscreen).call(e)}function exitFs(){(document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen).call(document)}function hideChrome(e){e?(__wasUiVisible=uiVisible,__wasSearchOpen=!(!searchBox||searchBox.classList.contains("hidden")),uiVisible=!1,applyUIVisibility(),searchBtn&&searchBtn.classList.add("hidden"),playlistSel&&playlistSel.classList.add("hidden"),searchBox&&searchBox.classList.add("hidden")):(null!==__wasUiVisible&&(uiVisible=__wasUiVisible,__wasUiVisible=null),applyUIVisibility(),searchBtn&&searchBtn.classList.remove("hidden"),playlistSel&&playlistSel.classList.remove("hidden"),searchBox&&(__wasSearchOpen?searchBox.classList.remove("hidden"):searchBox.classList.add("hidden")))}document.addEventListener("keydown",e=>{const t=(e.key||e.code||"").toLowerCase(),a=e.target,n=a&&a.tagName?a.tagName.toUpperCase():"",r=!!a&&(a.isContentEditable||"INPUT"===n||"TEXTAREA"===n||"SELECT"===n),o=document.getElementById("searchPanel"),s=!(!o||o.classList.contains("hidden"));if("escape"===t)return uiVisible=!uiVisible,applyUIVisibility(),void e.preventDefault();if(!(r||s||e.metaKey||e.ctrlKey||e.altKey||e.defaultPrevented)){if("f"===t)return isFs()?(exitFs(),hideChrome(!1)):(enterFs(),hideChrome(!0)),void e.preventDefault();if("arrowleft"!==t){if("arrowright"!==t);else if(Array.isArray(playlist)&&playlist.length&&"function"==typeof nextInPlaylist){try{autoAdvance=!1}catch{}nextInPlaylist(),e.preventDefault()}}else if(Array.isArray(playlist)&&playlist.length&&"function"==typeof prevInPlaylist){try{autoAdvance=!1}catch{}prevInPlaylist(),e.preventDefault()}}},{passive:!1}),["fullscreenchange","webkitfullscreenchange","mozfullscreenchange","MSFullscreenChange"].forEach(e=>document.addEventListener(e,()=>{isFs()||hideChrome(!1)}));const source={type:"none",tex:null,stream:null,videoEl:null,imageEl:null,audioEl:null,spectrumCanvas:null,spectrumCtx:null,spectrumTex:null};function resolveUrl(e){try{return new URL(e,location.href).href}catch(t){return e}}function videoHasFrame(e){return e&&e.readyState>=2&&e.videoWidth>0&&e.videoHeight>0}let audioCtx=null,analyser=null,freqData=null,audioSrcNode=null,streamSrcNode=null,audioElNode=null;const MEDIA_NODE=new WeakMap;async function ensureAudioCtx(){audioCtx||(audioCtx=new(window.AudioContext||window.webkitAudioContext),analyser=audioCtx.createAnalyser(),analyser.fftSize=512,analyser.smoothingTimeConstant=.72,freqData=new Uint8Array(analyser.frequencyBinCount))}function disconnectAudio(){try{audioSrcNode&&audioSrcNode.disconnect()}catch(e){}try{streamSrcNode&&streamSrcNode.disconnect()}catch(e){}try{audioElNode&&audioElNode.disconnect()}catch(e){}audioSrcNode=streamSrcNode=audioElNode=null}function connectVideoElAudio(e){if(!e||!audioCtx)return;disconnectAudio();let t=MEDIA_NODE.get(e);if(!t)try{t=audioCtx.createMediaElementSource(e),MEDIA_NODE.set(e,t)}catch(e){return}audioSrcNode=t;try{audioSrcNode.connect(analyser),audioSrcNode.connect(audioCtx.destination)}catch(e){}}function connectStreamAudio(e){if(e&&audioCtx){disconnectAudio();try{streamSrcNode=audioCtx.createMediaStreamSource(e),streamSrcNode.connect(analyser)}catch(e){}}}function connectAudioEl(e){if(!e||!audioCtx)return;disconnectAudio();let t=MEDIA_NODE.get(e);if(!t)try{t=audioCtx.createMediaElementSource(e),MEDIA_NODE.set(e,t)}catch(e){return}audioElNode=t;try{audioElNode.connect(analyser),audioElNode.connect(audioCtx.destination)}catch(e){}}let hls=null,dash=null;function destroyABR(){if(hls){try{hls.destroy()}catch(e){}hls=null}if(dash){try{dash.reset()}catch(e){}dash=null}}function setTexture(e){source.tex=e,sphereMat.uniforms.uTex.value=e,reflectMatBottom.uniforms.uTex.value=e,reflectMatTop.uniforms.uTex.value=e,spherePointsMat.uniforms.uTex.value=e;const t=e?1:0;sphereMat.uniforms.uUseTex.value=t,reflectMatBottom.uniforms.uUseTex.value=t,reflectMatTop.uniforms.uUseTex.value=t,spherePointsMat.uniforms.uUseTex.value=t}function stopWebcam(){source.stream&&(source.stream.getTracks().forEach(e=>e.stop()),source.stream=null),source.videoEl&&source.videoEl.srcObject&&(source.videoEl.srcObject=null)}function clearAudio(){if(source.audioEl){try{source.audioEl.pause()}catch(e){}source.audioEl.removeAttribute("src"),source.audioEl.load(),source.audioEl=null}if(source.spectrumTex)try{source.spectrumTex.dispose()}catch(e){}source.spectrumTex=null,source.spectrumCanvas=null,source.spectrumCtx=null}function clearVideoFile(){if(source.videoEl&&"video"===source.type){try{source.videoEl.pause()}catch(e){}source.videoEl.removeAttribute("src"),source.videoEl.load()}}function clearImage(){source.imageEl=null}function clearSource(){destroyABR(),stopWebcam(),clearAudio(),disconnectAudio(),clearVideoFile(),clearImage(),setTexture(null),source.type="none",webcamBtn.textContent="Webcam: OFF"}function getOrCreateVideo(){if(source.videoEl)return source.videoEl;const e=document.createElement("video");return e.autoplay=!0,e.playsInline=!0,e.muted=!1,e.loop=!1,e.crossOrigin="anonymous",source.videoEl=e,e}async function awaitCanPlay(e){videoHasFrame(e)||await new Promise((t,a)=>{const n=()=>{o(),t()},r=()=>{o(),a(new Error("[Media] video error"))},o=()=>{e.removeEventListener("canplay",n),e.removeEventListener("loadeddata",n),e.removeEventListener("error",r)};e.addEventListener("canplay",n,{once:!0}),e.addEventListener("loadeddata",n,{once:!0}),e.addEventListener("error",r,{once:!0})})}async function tryPlay(e){try{return await e.play(),!0}catch(e){return!1}}function buildSpectrumTexture(e=256,t=256){const a=document.createElement("canvas");a.width=e,a.height=t;const n=a.getContext("2d"),r=new THREE.CanvasTexture(a);return r.colorSpace=THREE.SRGBColorSpace,r.minFilter=THREE.LinearFilter,r.magFilter=THREE.LinearFilter,source.spectrumCanvas=a,source.spectrumCtx=n,source.spectrumTex=r,r}function drawSpectrumTexture(){if(!source.spectrumCtx||!freqData)return;const e=source.spectrumCtx,{width:t,height:a}=source.spectrumCanvas;e.fillStyle="#000",e.fillRect(0,0,t,a);const n=freqData.length,r=t/n;for(let t=0;t<n;t++){const n=freqData[t]/255,o=n*a,s=e.createLinearGradient(0,a-o,0,a);s.addColorStop(0,`rgba(${Math.floor(255*n)},${Math.floor(255*(1-n))},255,1)`),s.addColorStop(1,"rgba(80,80,120,1)"),e.fillStyle=s,e.fillRect(t*r,a-o,Math.max(1,r-1),o)}source.spectrumTex&&(source.spectrumTex.needsUpdate=!0)}function encodePath(e){return e.split("/").map(encodeURIComponent).join("/")}function mediaTypeFromExt(e){const t=e.split(".").pop()?.toLowerCase()||"";return["mp3","wav","ogg","m4a","flac","aac"].includes(t)?"audio":["mp4","webm","ogv","mov","m4v"].includes(t)?"video":["jpg","jpeg","png","gif","webp","bmp"].includes(t)?"image":"m3u8"===t?"hls":"mpd"===t?"dash":"unknown"}function parseTreeToFiles(e){const t=[],a=[],n=e.split("\n"),r=/^([\s│]*)(?:├──|└──)\s+([^.\n\r]+)$/,o=/^([\s│]*)(?:├──|└──)\s+(.+\.[A-Za-z0-9]+)$/,s=e=>(e.match(/│/g)||[]).length;for(let e of n){const n=e.replace(/\r/g,"").trimEnd();if(!n)continue;let i=n.match(r);if(i){const e=s(i[1]),t=i[2].trim();a[e]=t,a.length=e+1;continue}if(i=n.match(o),i){const e=s(i[1]),n=i[2].trim(),r=a.slice(0,e+1).filter(Boolean),o=(r.length?r.join("/")+"/":"")+n;t.push(o)}}return t}function buildPlaylist(e,t="."){const a=[];for(const n of e){const e=mediaTypeFromExt(n);if("unknown"===e)continue;const r=("."===t?"":t.replace(/\/+$/,"")+"/")+encodePath(n);a.push({type:e,label:n,url:r})}return a.sort((e,t)=>{const a={hls:0,dash:1,video:2,image:3,audio:4,unknown:5};return a[e.type]!==a[t.type]?a[e.type]-a[t.type]:e.label.localeCompare(t.label,void 0,{numeric:!0,sensitivity:"base"})}),a}async function loadPlaylistFromTreeFile(e,t="."){try{const a=await fetch(e,{cache:"no-store"});if(!a.ok)throw new Error(`${a.status} ${a.statusText}`);const n=await a.text(),r=buildPlaylist(parseTreeToFiles(n),t);return r.length?(playlist.length=0,playlist.push(...r),refreshPlaylistSelect(),console.info("[Playlist] Loaded from tree:",playlist.length,"items"),!0):(console.warn("[Playlist] Tree parsed but no playable media found."),!1)}catch(e){return console.error("[Playlist] Failed to load from tree",e),!1}}const playlist=[];let currentIndex=0,autoAdvance=!0;function refreshPlaylistSelect(){playlistSelect.innerHTML="",playlist.forEach((e,t)=>{const a=document.createElement("option");a.value=String(t),a.textContent=`${t+1}. [${e.type}] ${e.label}`,playlistSelect.appendChild(a)}),playlist.length&&(playlistSelect.value=String(currentIndex))}const BASE_MEDIA_PATH="media/archives",TREE_FILE_PATH="media/archives/audioteka.txt";async function loadPlaylistIndex(e){if(e<0||e>=playlist.length)return!1;if(autoAdvance=!0,currentIndex=e,refreshPlaylistSelect(),schedulePersist(),await ensureAudioCtx(),audioCtx&&"suspended"===audioCtx.state)try{await audioCtx.resume()}catch(e){}const t=playlist[e];if(destroyABR(),"image"!==t.type&&clearImage(),"webcam"!==t.type&&stopWebcam(),clearAudio(),disconnectAudio(),setTexture(null),"webcam"===t.type)try{const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:!0}),t=getOrCreateVideo();t.muted=!0,t.srcObject=e,await awaitCanPlay(t),await tryPlay(t);const a=new THREE.VideoTexture(t);return a.colorSpace=THREE.SRGBColorSpace,a.minFilter=THREE.LinearFilter,a.magFilter=THREE.LinearFilter,clearVideoFile(),source.type="webcam",source.stream=e,setTexture(a),connectStreamAudio(e),webcamBtn.textContent="Webcam: ON",schedulePersist(),!0}catch(e){return console.error("[Webcam] failed",e),!1}if("image"===t.type)try{const e=new Image;e.crossOrigin="anonymous",await new Promise((a,n)=>{e.onload=a,e.onerror=n,e.src=resolveUrl(t.url)});const a=new THREE.Texture(e);return a.needsUpdate=!0,a.colorSpace=THREE.SRGBColorSpace,source.type="image",source.imageEl=e,setTexture(a),schedulePersist(),!0}catch(e){return console.error("[Image] load failed",t.url,e),!1}if("audio"===t.type)try{if(await ensureAudioCtx(),audioCtx&&"suspended"===audioCtx.state)try{await audioCtx.resume()}catch{}destroyABR(),stopWebcam(),clearVideoFile(),clearImage(),clearAudio(),disconnectAudio(),setTexture(null);const e=new Audio;e.crossOrigin="anonymous",e.autoplay=!0,e.loop=!1,e.src=resolveUrl(t.url),e.onended=()=>{autoAdvance&&nextInPlaylist()},e.onerror=()=>{autoAdvance&&nextInPlaylist()};if(!await tryPlay(e))return!1;connectAudioEl(e);const a=buildSpectrumTexture(256,256);return source.type="audio",source.audioEl=e,setTexture(a),schedulePersist(),!0}catch(e){return console.error("[Audio] setup failed",e),!1}try{const e=getOrCreateVideo();e.crossOrigin="anonymous",e.loop=!1;let a=!1;const n=resolveUrl(t.url);if("hls"===t.type)if(e.canPlayType("application/vnd.apple.mpegurl"))e.src=n,await awaitCanPlay(e),a=await tryPlay(e);else{if(!window.Hls||!window.Hls.isSupported())return!1;hls=new window.Hls({enableWorker:!0,lowLatencyMode:!0}),hls.attachMedia(e),await new Promise(t=>{hls.on(window.Hls.Events.MEDIA_ATTACHED,()=>{hls.loadSource(n)}),hls.on(window.Hls.Events.MANIFEST_PARSED,async()=>{await awaitCanPlay(e),a=await tryPlay(e),t()})})}else if("dash"===t.type){if(!window.dashjs)return!1;dash=window.dashjs.MediaPlayer().create(),dash.initialize(e,n,!1),await awaitCanPlay(e),a=await tryPlay(e)}else e.src=n,await awaitCanPlay(e),a=await tryPlay(e);if(!a)return!1;if(source.tex&&source.tex.dispose)try{source.tex.dispose()}catch(e){}const r=new THREE.VideoTexture(e);return r.colorSpace=THREE.SRGBColorSpace,r.minFilter=THREE.LinearFilter,r.magFilter=THREE.LinearFilter,source.type="video",source.videoEl=e,setTexture(r),connectVideoElAudio(e),schedulePersist(),!0}catch(e){return console.error("[Video] setup/texture failed",e),!1}}function nextInPlaylist(){if(!Array.isArray(playlist)||0===playlist.length)return;if(1===playlist.length)return void loadPlaylistIndex(0);let e=currentIndex+1;if(e>=playlist.length){if(!loopChk.checked)return void loadPlaylistIndex(currentIndex);e=0}loadPlaylistIndex(e)}function prevInPlaylist(){if(!Array.isArray(playlist)||0===playlist.length)return;if(1===playlist.length)return void loadPlaylistIndex(0);let e=currentIndex-1;if(e<0){if(!loopChk.checked)return void loadPlaylistIndex(currentIndex);e=playlist.length-1}loadPlaylistIndex(e)}loadPlaylistFromTreeFile(TREE_FILE_PATH,BASE_MEDIA_PATH).then(async e=>{e||(console.warn("[Playlist] falling back to demo entry"),playlist.push({type:"hls",label:"HLS test",url:"media/test/KuzniakTeicherHope/master.m3u8"}),refreshPlaylistSelect()),await restoreFromStorageOrPreset()}),webcamBtn.addEventListener("click",async()=>{if(await beginFrom("webcam"),"webcam"!==source.type){autoAdvance=!1;try{await ensureAudioCtx(),destroyABR(),disconnectAudio(),clearVideoFile(),clearImage(),clearAudio(),stopWebcam();const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:!0}),t=getOrCreateVideo();t.muted=!0,t.srcObject=e,await awaitCanPlay(t),await tryPlay(t);const a=new THREE.VideoTexture(t);a.colorSpace=THREE.SRGBColorSpace,source.type="webcam",source.stream=e,setTexture(a),connectStreamAudio(e),webcamBtn.textContent="Webcam: ON"}catch(e){console.error("[Webcam] blocked/error",e),webcamBtn.textContent="Webcam blocked"}}else clearSource()}),imgInput.addEventListener("change",async e=>{await beginFrom("image");const t=e.target.files?.[0];if(!t)return;autoAdvance=!1,destroyABR(),stopWebcam(),disconnectAudio(),clearAudio(),clearVideoFile(),clearImage();const a=URL.createObjectURL(t),n=new Image;n.crossOrigin="anonymous",n.onload=()=>{const e=new THREE.Texture(n);e.needsUpdate=!0,e.colorSpace=THREE.SRGBColorSpace,source.type="image",source.imageEl=n,setTexture(e)},n.onerror=e=>{console.error("[Image] load error",e)},n.src=a}),vidInput.addEventListener,audioInput.addEventListener("change",async e=>{const t=e.target.files?.[0];if(!t)return;if(autoAdvance=!1,await ensureAudioCtx(),"suspended"===audioCtx.state)try{await audioCtx.resume()}catch(e){}destroyABR(),stopWebcam(),clearVideoFile(),clearImage(),clearAudio(),disconnectAudio(),setTexture(null);const a=URL.createObjectURL(t),n=new Audio;n.crossOrigin="anonymous",n.autoplay=!0,n.loop=!1,n.src=a;if(!await tryPlay(n))return void console.error("[Audio] play failed");connectAudioEl(n);const r=buildSpectrumTexture(256,256);source.type="audio",source.audioEl=n,setTexture(r)}),clearBtn.addEventListener("click",()=>{clearSource()}),startBtn.addEventListener("click",async()=>{if(await beginFrom("start"),await ensureAudioCtx(),audioCtx&&"suspended"===audioCtx.state)try{await audioCtx.resume()}catch(e){}autoAdvance=!0,playlist.length&&loadPlaylistIndex(currentIndex)}),prevBtn.addEventListener("click",async()=>{await beginFrom("prev"),prevInPlaylist()}),nextBtn.addEventListener("click",async()=>{await beginFrom("next"),nextInPlaylist()}),playlistSelect.addEventListener("change",async()=>{await beginFrom("playlist");loadPlaylistIndex(parseInt(playlistSelect.value,10))});const shared={uTime:{value:0},uLightDir:{value:new THREE.Vector3(.5,.9,.3).normalize()},uSaturation:{value:1}},satGLSL="vec3 sat(vec3 c, float s){ float l = dot(c, vec3(0.2126,0.7152,0.0722)); return mix(vec3(l), c, s); }",rainbowGLSL="\n  const float PI = 3.141592653589793;\n  vec3 h2rgb(float h){\n    vec3 k = vec3(0.0, 4.0, 2.0);\n    return clamp(abs(mod(h*6.0 + k, 6.0) - 3.0) - 1.0, 0.0, 1.0);\n  }\n  vec3 rainbowByAngle(float ang, float rot){\n    float h = fract((ang + rot) / (2.0*PI));\n    return h2rgb(h);\n  }\n",sphereVert=`\n      uniform float uTime,uAmp,uFreq,uTexStrength; uniform sampler2D uTex; uniform int uUseTex;\n      varying vec3 vNormalW; varying vec3 vPosW; varying vec2 vUvV;\n      ${simplexGLSL}\n      float luma(vec3 c){ return dot(c, vec3(0.2126,0.7152,0.0722)); }\n      void main(){\n        vec3 pos = position; vUvV = uv;\n        float camDisp = 0.0;\n        if(uUseTex==1){ vec2 suv = vec2(1.0 - vUvV.x, vUvV.y); vec3 texel = texture2D(uTex, suv).rgb; camDisp = (0.5 - luma(texel)) * uTexStrength; }\n        float n = snoise(normal*uFreq + vec3(0.0,0.0,uTime*0.25));\n        float disp = n*(uAmp*0.35) + camDisp*(uAmp*1.35);\n        disp = clamp(disp, -uAmp*1.35, uAmp*1.35);\n        pos += normal * disp;\n        vec4 worldPos = modelMatrix * vec4(pos, 1.0);\n        vPosW = worldPos.xyz; vNormalW = normalize(mat3(modelMatrix)*normal);\n        gl_Position = projectionMatrix * viewMatrix * worldPos;\n      }\n`,sphereFrag=`\n      precision highp float;\n      uniform vec3 uColor,uLightDir; uniform sampler2D uTex; uniform int uUseTex; uniform float uSaturation;\n      uniform int uRainbowOn; uniform float uRainbowRot;\n      varying vec3 vNormalW; varying vec3 vPosW; varying vec2 vUvV;\n      ${satGLSL}\n      ${rainbowGLSL}\n      void main(){\n        vec3 baseCol = uColor;\n        if(uUseTex==1){\n          vec2 suv=vec2(1.0 - vUvV.x, vUvV.y);\n          baseCol = texture2D(uTex, suv).rgb;\n        }else if(uRainbowOn==1){\n          float ang = atan(vNormalW.z, vNormalW.x);\n          baseCol = rainbowByAngle(ang, uRainbowRot);\n        }\n        baseCol = sat(baseCol, uSaturation);\n        vec3 N=normalize(vNormalW), L=normalize(uLightDir);\n        float lambert = max(dot(N,L),0.0);\n        vec3 col = baseCol*(0.18 + 0.82*lambert);\n        float fres = pow(1.0 - max(dot(N, normalize(-vPosW)), 0.0), 3.0)*0.22;\n        col += fres*vec3(1.0,0.7,0.9);\n        gl_FragColor = vec4(col, 1.0);\n      }\n`,sphereMat=new THREE.ShaderMaterial({uniforms:{...shared,uColor:{value:new THREE.Color(16732095)},uAmp:{value:.22},uFreq:{value:1.2},uTex:{value:null},uUseTex:{value:0},uTexStrength:{value:1},uRainbowOn:{value:0},uRainbowRot:{value:0}},vertexShader:sphereVert,fragmentShader:sphereFrag,wireframe:!1}),sphereGeo=new THREE.SphereGeometry(1,160,160),sphere=new THREE.Mesh(sphereGeo,sphereMat);sphere.position.y=1.15,scene.add(sphere);const reflectVert=`\n      uniform float uTime,uAmp,uFreq,uWobbleAmp,uWobbleFreq,uTexStrength; uniform sampler2D uTex; uniform int uUseTex;\n      varying vec3 vPosW; varying vec3 vNormalW; varying vec2 vUvV;\n      ${simplexGLSL}\n      float luma(vec3 c){ return dot(c, vec3(0.2126,0.7152,0.0722)); }\n      void main(){\n        vec3 pos = position; vUvV = uv;\n        float camDisp = 0.0;\n        if(uUseTex==1){ vec2 suv = vec2(1.0 - vUvV.x, vUvV.y); vec3 texel = texture2D(uTex, suv).rgb; camDisp = (0.5 - luma(texel)) * uTexStrength; }\n        float n = snoise(normal*uFreq + vec3(0.0,0.0,uTime*0.25));\n        float disp = n*(uAmp*0.30) + camDisp*(uAmp*1.10);\n        disp = clamp(disp, -uAmp*1.10, uAmp*1.10);\n        pos += normal*disp;\n        vec4 wp = modelMatrix * vec4(pos,1.0);\n        float wob = snoise(vec3(wp.xz*uWobbleFreq, uTime*0.3));\n        wp.x += wob*uWobbleAmp; wp.z += wob*uWobbleAmp;\n        vPosW=wp.xyz; vNormalW=normalize(mat3(modelMatrix)*normal);\n        gl_Position = projectionMatrix * viewMatrix * wp;\n      }\n`,reflectFrag=`\n      precision highp float;\n      uniform vec3 uColor,uLightDir; uniform float uAlpha,uR,uSoft,uSaturation; uniform sampler2D uTex; uniform int uUseTex;\n      uniform int uRainbowOn; uniform float uRainbowRot;\n      varying vec3 vPosW; varying vec3 vNormalW; varying vec2 vUvV;\n      ${satGLSL}\n      ${rainbowGLSL}\n      void main(){\n        vec3 baseCol=uColor;\n        if(uUseTex==1){\n          vec2 suv=vec2(1.0 - vUvV.x, vUvV.y);\n          baseCol = texture2D(uTex, suv).rgb;\n        }else if(uRainbowOn==1){\n          float ang = atan(vPosW.z, vPosW.x);\n          baseCol = rainbowByAngle(ang, uRainbowRot);\n        }\n        baseCol = sat(baseCol, uSaturation);\n        vec3 N=normalize(vNormalW), L=normalize(uLightDir);\n        float lambert=max(dot(N,L),0.0);\n        vec3 col = baseCol*(0.10+0.90*lambert);\n        float r=length(vPosW.xz), fall=1.0 - smoothstep(uR, uR+uSoft, r);\n        gl_FragColor = vec4(col*0.85, uAlpha*fall);\n      }\n`;function makeReflectMat(){return new THREE.ShaderMaterial({uniforms:{...shared,uColor:{value:new THREE.Color(16732095)},uAmp:{value:.22},uFreq:{value:1.2},uWobbleAmp:{value:.015},uWobbleFreq:{value:1.6},uAlpha:{value:.55},uR:{value:1.6},uSoft:{value:1},uTex:{value:null},uUseTex:{value:0},uTexStrength:{value:1},uRainbowOn:{value:0},uRainbowRot:{value:0}},vertexShader:reflectVert,fragmentShader:reflectFrag,transparent:!0,depthWrite:!0,blending:THREE.NormalBlending})}const reflectMatBottom=makeReflectMat(),reflectMatTop=makeReflectMat(),mirrorBottom=new THREE.Mesh(new THREE.SphereGeometry(1,160,160),reflectMatBottom);mirrorBottom.position.y=-1.15,mirrorBottom.scale.y=-1,scene.add(mirrorBottom);const mirrorTop=new THREE.Mesh(new THREE.SphereGeometry(1,160,160),reflectMatTop);mirrorTop.position.y=3.45,mirrorTop.scale.y=1,scene.add(mirrorTop);const pointsVert=`\n      uniform float uTime,uAmp,uFreq,uTexStrength,uPointSize; uniform sampler2D uTex; uniform int uUseTex;\n      uniform vec3 uLightDir;\n      varying vec3 vNormalW; varying vec3 vPosW; varying vec2 vUvV;\n      ${simplexGLSL}\n      float luma(vec3 c){ return dot(c, vec3(0.2126,0.7152,0.0722)); }\n      void main(){\n        vec3 pos = position; vUvV = uv;\n        float camDisp = 0.0;\n        if(uUseTex==1){ vec2 suv = vec2(1.0 - vUvV.x, vUvV.y); vec3 texel = texture2D(uTex, suv).rgb; camDisp = (0.5 - luma(texel)) * uTexStrength; }\n        float n = snoise(normal*uFreq + vec3(0.0,0.0,uTime*0.25));\n        float disp = n*(uAmp*0.35) + camDisp*(uAmp*1.35);\n        disp = clamp(disp, -uAmp*1.35, uAmp*1.35);\n        pos += normal * disp;\n        vec4 worldPos = modelMatrix * vec4(pos,1.0);\n        vPosW = worldPos.xyz; vNormalW = normalize(mat3(modelMatrix)*normal);\n        vec4 mv = viewMatrix * worldPos;\n        gl_PointSize = uPointSize * (300.0 / -mv.z);\n        gl_Position = projectionMatrix * mv;\n      }\n`,pointsFrag=`\n      precision highp float;\n      uniform sampler2D uTex; uniform int uUseTex; uniform float uSaturation; uniform vec3 uColor; uniform vec3 uLightDir;\n      uniform int uRainbowOn; uniform float uRainbowRot;\n      varying vec3 vNormalW; varying vec3 vPosW; varying vec2 vUvV;\n      ${satGLSL}\n      ${rainbowGLSL}\n      void main(){\n        vec2 d = gl_PointCoord*2.0 - 1.0; float r = dot(d,d); if(r>1.0) discard;\n        vec3 baseCol = uColor;\n        if(uUseTex==1){\n          vec2 suv=vec2(1.0 - vUvV.x, vUvV.y);\n          baseCol = texture2D(uTex, suv).rgb;\n        }else if(uRainbowOn==1){\n          float ang = atan(vNormalW.z, vNormalW.x);\n          baseCol = rainbowByAngle(ang, uRainbowRot);\n        }\n        baseCol = sat(baseCol, uSaturation);\n        vec3 N=normalize(vNormalW), L=normalize(uLightDir);\n        float lambert=max(dot(N,L),0.0);\n        vec3 col = baseCol*(0.18 + 0.82*lambert);\n        gl_FragColor = vec4(col,1.0);\n      }\n`,spherePointsMat=new THREE.ShaderMaterial({uniforms:{...shared,uColor:{value:new THREE.Color(16732095)},uAmp:{value:.22},uFreq:{value:1.2},uTex:{value:null},uUseTex:{value:0},uTexStrength:{value:1},uPointSize:{value:2.2},uRainbowOn:{value:0},uRainbowRot:{value:0}},vertexShader:pointsVert,fragmentShader:pointsFrag,transparent:!0,depthWrite:!1}),spherePoints=new THREE.Points(new THREE.SphereGeometry(1,160,160),spherePointsMat);spherePoints.position.y=1.15,spherePoints.visible=!1,scene.add(spherePoints);const BIN_COUNT=128,specGeo=new THREE.BufferGeometry,specPos=new Float32Array(384),specCol=new Float32Array(384);for(let e=0;e<128;e++){const t=e/128*Math.PI*2;specPos[3*e+0]=2*Math.cos(t),specPos[3*e+1]=1.15,specPos[3*e+2]=2*Math.sin(t),specCol[3*e+0]=1,specCol[3*e+1]=1,specCol[3*e+2]=1}specGeo.setAttribute("position",new THREE.BufferAttribute(specPos,3)),specGeo.setAttribute("aColor",new THREE.BufferAttribute(specCol,3));const specMat=new THREE.ShaderMaterial({uniforms:{uSize:{value:10},uShape:{value:0}},vertexShader:"uniform float uSize; attribute vec3 aColor; varying vec3 vColor; void main(){ vColor=aColor; vec4 mv=modelViewMatrix*vec4(position,1.0); gl_PointSize=uSize*(300.0/-mv.z); gl_Position=projectionMatrix*mv; }",fragmentShader:"precision highp float; varying vec3 vColor; uniform int uShape;\n        float sdEquilateralTri(vec2 p){ const float k=1.7320508075688772; p.x=abs(p.x)-0.5; p.y=p.y+0.28867513459481287;\n          if(p.x+k*p.y>0.0) p=vec2(p.x-k*p.y,-k*p.x-p.y)/2.0; p.x-=clamp(p.x,-1.0,0.0); return -length(p)*sign(p.y); }\n        float sdCross(vec2 p){ p=abs(p); float w=0.3; float d1=max(p.x-w,p.y-1.0); float d2=max(p.y-w,p.x-1.0); return min(d1,d2); }\n        void main(){\n          vec2 uv=gl_PointCoord*2.0-1.0; float a=0.0;\n          if(uShape==0){ float r=dot(uv,uv); if(r>1.0) discard; a=smoothstep(1.0,0.7,r); }\n          else if(uShape==1){ float m=max(abs(uv.x),abs(uv.y)); if(m>1.0) discard; a=smoothstep(1.0,0.7,m); }\n          else if(uShape==2){ float d=sdEquilateralTri(uv); if(d>0.0) discard; a=smoothstep(0.0,-0.3,d); }\n          else { float d=sdCross(uv); if(d>0.0) discard; a=smoothstep(0.0,-0.3,d); }\n          gl_FragColor=vec4(vColor,a);\n}",transparent:!0,depthWrite:!1}),spectrumPoints=new THREE.Points(specGeo,specMat);spectrumPoints.visible=!1,scene.add(spectrumPoints);const specGeoLine=new THREE.BufferGeometry,specPosLine=new Float32Array(384),specColLine=new Float32Array(384);specGeoLine.setAttribute("position",new THREE.BufferAttribute(specPosLine,3)),specGeoLine.setAttribute("color",new THREE.BufferAttribute(specColLine,3));const specLineMat=new THREE.LineBasicMaterial({linewidth:1,vertexColors:!0,transparent:!0,opacity:1}),spectrumLine=new THREE.LineLoop(specGeoLine,specLineMat);function hslToRgb(e,t,a){e=(e%1+1)%1;const n=t*Math.min(a,1-a),r=t=>{const r=t+12*e,o=r-12*Math.floor(r/12);return a-n*Math.max(-1,Math.min(o-3,9-o,1))};return[r(0),r(8),r(4)]}spectrumLine.visible=!1,scene.add(spectrumLine);const particlesParent=new THREE.Group;scene.add(particlesParent);let pointsField=null,pGeo=null,pMat=null,P_COUNT=600,vel=null,lockedId=-1,hoveredId=-1;const mousePx={x:-1,y:-1},readBuf=new Uint8Array(4);let pickScene=null,pickPoints=null,pickMat=null,pickTarget=null;const __ndc=new THREE.Vector2,__raycaster=new THREE.Raycaster,__planeY=new THREE.Plane,__hitY=new THREE.Vector3;function pointerWorldAtY(e,t,a){const n=renderer.domElement.getBoundingClientRect();return __ndc.x=(e-n.left)/n.width*2-1,__ndc.y=-(t-n.top)/n.height*2+1,__raycaster.setFromCamera(__ndc,camera),__planeY.set(new THREE.Vector3(0,1,0),-a),__raycaster.ray.intersectPlane(__planeY,__hitY),__hitY}function buildPickTarget(){pickTarget&&pickTarget.dispose();const e=renderer.domElement.width,t=renderer.domElement.height;pickTarget=new THREE.WebGLRenderTarget(e,t,{depthBuffer:!1,stencilBuffer:!1})}function pickParticleUnderMouse(){if(!pickScene||!pointsField||!pickTarget)return;if(mousePx.x<0||mousePx.y<0)return;const e=renderer.domElement,t=Math.max(0,Math.min(e.width-1,mousePx.x)),a=Math.max(0,Math.min(e.height-1,e.height-1-mousePx.y)),n=renderer.getRenderTarget();renderer.setRenderTarget(pickTarget),renderer.clear(),renderer.render(pickScene,camera),renderer.readRenderTargetPixels(pickTarget,t,a,1,1,readBuf),renderer.setRenderTarget(n);const r=readBuf[0]<<16|readBuf[1]<<8|readBuf[2],o=r>=0&&r<P_COUNT?r:-1;o!==hoveredId&&(hoveredId=o,-1!==hoveredId&&console.log("[particle:hover]",hoveredId))}function particlesOnResize(){buildPickTarget()}let lockUntil=0;renderer.domElement.addEventListener("mousemove",e=>{const t=renderer.domElement.getBoundingClientRect();mousePx.x=Math.floor((e.clientX-t.left)*(renderer.domElement.width/t.width)),mousePx.y=Math.floor((e.clientY-t.top)*(renderer.domElement.height/t.height)),mousePx.clientX=e.clientX,mousePx.clientY=e.clientY}),renderer.domElement.addEventListener("mouseleave",()=>{mousePx.x=mousePx.y=-1}),renderer.domElement.addEventListener("mouseleave",()=>{mousePx.x=mousePx.y=-1,mousePx.clientX=mousePx.clientY=void 0},{passive:!0}),renderer.domElement.addEventListener("pointerdown",()=>{-1===lockedId&&hoveredId>=0&&(lockedId=hoveredId,console.log("[particle:lock]",lockedId))}),renderer.domElement.addEventListener("dblclick",()=>{hoveredId===lockedId&&-1!==lockedId&&(console.log("[particle:release]",lockedId),lockedId=-1)},{passive:!0});const ATTRACTORS=[];function addAttractor(e={}){const t={color:5088255,dotSize:.035,speed:.55,rX:2,rZ:1.3,yBase:1.15,yAmp:.35,radius:.9,strength:9,dampingToward:2.5,phase:Math.random()*Math.PI*2};Object.assign(t,e);const a=new THREE.Group,n=new THREE.SphereGeometry(t.dotSize,16,16),r=new THREE.MeshBasicMaterial({color:t.color}),o=new THREE.Mesh(n,r);a.add(o);const s=new THREE.BufferGeometry,i=new Float32Array(6);s.setAttribute("position",new THREE.BufferAttribute(i,3));const l=new THREE.LineBasicMaterial({color:t.color,transparent:!0,opacity:.95}),c=new THREE.Line(s,l);a.add(c),scene.add(a);const u={group:a,dot:o,line:c,params:t,t:t.phase};return ATTRACTORS.push(u),u}function removeAttractor(e){const t=ATTRACTORS.indexOf(e);-1!==t&&(scene.remove(e.group),e.dot.geometry.dispose(),e.dot.material.dispose(),e.line.geometry.dispose(),e.line.material.dispose(),ATTRACTORS.splice(t,1))}function clearAttractors(){for(;ATTRACTORS.length;)removeAttractor(ATTRACTORS[0])}function updateAttractors(e){if(!ATTRACTORS.length)return;if(!pGeo||!vel)return;const t=pGeo.getAttribute("position");for(let a=0;a<ATTRACTORS.length;a++){const n=ATTRACTORS[a],r=n.params;n.t+=e*r.speed;const o=Math.cos(n.t)*r.rX,s=Math.sin(.97*n.t)*r.rZ,i=r.yBase+Math.sin(.63*n.t)*r.yAmp;n.dot.position.set(o,i,s);const l=n.line.geometry.getAttribute("position");l.setXYZ(0,0,0,0),l.setXYZ(1,o,i,s),l.needsUpdate=!0;const c=r.radius*r.radius,u=t.array;for(let t=0;t<P_COUNT;t++){const a=3*t,n=o-u[a+0],l=i-u[a+1],d=s-u[a+2],p=n*n+l*l+d*d;if(p>c)continue;const m=1-p/c,f=r.strength*m,h=r.dampingToward;vel[a+0]+=(n*f-vel[a+0]*h)*e,vel[a+1]+=(l*f-vel[a+1]*h)*e*.4,vel[a+2]+=(d*f-vel[a+2]*h)*e}}}let DEFAULT_ATTRACTOR=null;function initDefaultAttractors(){clearAttractors(),DEFAULT_ATTRACTOR=addAttractor({color:5088255,dotSize:.035,speed:.55,rX:2,rZ:1.3,yBase:1.15,yAmp:.35,radius:.9,strength:9,dampingToward:2.5})}initDefaultAttractors(),addAttractor({color:0,dotSize:.5,speed:.01,rX:3.6,rZ:1,yAmp:.25,radius:2,strength:20});const AmbientFlow=(()=>{const e={emitRate:3335,lifeMin:20,lifeMax:6,recycleRadius2:.05*.05,spawnJitter:.02,kickSpeed:.35,kickY:.1,kickSpread:1,orbit:{rBase:1.2,rAmp1:.4,rFreq1:.5,rAmp2:.2,rFreq2:.93,angSpeed:.7,angOscAmp:.3,angOscFreq:.25,yBase:1.15,yAmp:.35,yOsc1:.8,yOsc2:.3},returnGain:22,returnGainY:.5,swirlYFactor:.25,seed:null},t={mesh:null,t:0,spawnAcc:0,life:null,ttl:null,spawnIdx:0,rng:null};function a(){return t.rng?t.rng():Math.random()}function n(e,t){return e+(t-e)*a()}function r(e=1){return(2*a()-1)*e}function o(a){e.seed=null==a?null:0|a,t.rng=null==e.seed?null:function(e){let t=e>>>0||1;return function(){t|=0,t=t+1831565813|0;let e=Math.imul(t^t>>>15,1|t);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}(e.seed)}function s(o){const s=pGeo.getAttribute("position"),i=pGeo.getAttribute("seed"),l=e.spawnJitter,c=t.mesh.position.x+r(l),u=t.mesh.position.y+r(l),d=t.mesh.position.z+r(l);s.array[3*o+0]=c,s.array[3*o+1]=u,s.array[3*o+2]=d;const p=r(e.kickSpread),m=r(e.kickSpread),f=Math.max(1e-4,Math.hypot(p,m));vel[3*o+0]=p/f*e.kickSpeed,vel[3*o+1]=e.kickY*r(1),vel[3*o+2]=m/f*e.kickSpeed;const h=Math.hypot(c,d),g=Math.atan2(d,c);i.setX(o,Math.max(.8,h)),i.setY(o,.2+.25*a()),i.setZ(o,g),t.ttl[o]=n(e.lifeMin,e.lifeMax),t.life[o]=t.ttl[o]}return{configure:function(t={}){Object.assign(e,t),t.orbit&&Object.assign(e.orbit,t.orbit)},setSeed:o,createEmitter:function(){if(!t.mesh){t.mesh=new THREE.Mesh(new THREE.SphereGeometry(.02,12,12),new THREE.MeshBasicMaterial({color:16724016})),t.mesh.position.set(0*e.orbit.yBase,e.orbit.yBase,0),particlesParent.add(t.mesh),t.life=new Float32Array(P_COUNT),t.ttl=new Float32Array(P_COUNT);for(let a=0;a<P_COUNT;a++)t.ttl[a]=n(e.lifeMin,e.lifeMax),t.life[a]=n(0,t.ttl[a]);o(e.seed),console.log("[AmbientFlow] emitter initialized",{seed:e.seed})}},updateEmitter:function(a){t.t+=a;const n=e.orbit,r=n.rBase+n.rAmp1*Math.sin(t.t*n.rFreq1)+n.rAmp2*Math.sin(t.t*n.rFreq2),o=t.t*n.angSpeed+n.angOscAmp*Math.sin(t.t*n.angOscFreq),s=n.yBase+n.yAmp*Math.sin(t.t*n.yOsc1)*Math.cos(t.t*n.yOsc2);t.mesh.position.set(Math.cos(o)*r,s,Math.sin(o)*r)},respawnParticle:s,spawnLoop:function(a){t.spawnAcc+=a*e.emitRate;let n=0;for(;t.spawnAcc>=1&&n++<P_COUNT;){let e=t.spawnIdx++%P_COUNT,a=0;for(;t.life[e]>0&&a++<Math.min(P_COUNT,64);)e=t.spawnIdx++%P_COUNT;t.life[e]<=0&&s(e),t.spawnAcc-=1}},state:t,config:e}})();function buildParticles(e){pointsField&&(particlesParent.remove(pointsField),pGeo?.dispose(),pMat?.dispose()),P_COUNT=Math.max(0|e,Array.isArray(playlist)?playlist.length:0),pGeo=new THREE.BufferGeometry;const t=new Float32Array(3*P_COUNT),a=new Float32Array(3*P_COUNT),n=new Float32Array(P_COUNT),r=new Float32Array(P_COUNT),o=new Float32Array(3*P_COUNT),s=new Float32Array(3*P_COUNT);vel=new Float32Array(3*P_COUNT);for(let e=0;e<P_COUNT;e++){const i=1.8+1.2*Math.random(),l=Math.random()*Math.PI*2,c=.6*Math.random()-.3+1.15;if(t[3*e+0]=Math.cos(l)*i,t[3*e+1]=c,t[3*e+2]=Math.sin(l)*i,a[3*e+0]=i,a[3*e+1]=.2+.25*Math.random(),a[3*e+2]=l,vel[3*e+0]=vel[3*e+1]=vel[3*e+2]=0,n[e]=.01,r[e]=10,e<(playlist?.length||0)){const t=e/Math.max(1,playlist.length),a=(new THREE.Color).setHSL(t,.9,.6);s[3*e+0]=a.r,s[3*e+1]=a.g,s[3*e+2]=a.b}else s[3*e+0]=1,s[3*e+1]=1,s[3*e+2]=1;o[3*e+0]=s[3*e+0],o[3*e+1]=s[3*e+1],o[3*e+2]=s[3*e+2]}pGeo.setAttribute("position",new THREE.BufferAttribute(t,3)),pGeo.setAttribute("seed",new THREE.BufferAttribute(a,3)),pGeo.setAttribute("aSize",new THREE.BufferAttribute(n,1)),pGeo.setAttribute("aBoost",new THREE.BufferAttribute(r,1)),pGeo.setAttribute("aTint",new THREE.BufferAttribute(o,3)),pGeo.setAttribute("aBaseTint",new THREE.BufferAttribute(s,3));pMat=new THREE.ShaderMaterial({uniforms:{uPointSizePx:{value:0}},vertexShader:"\n    uniform float uPointSizePx;\n    attribute float aSize;\n    attribute float aBoost;\n    attribute vec3  aTint;\n    varying vec3  vTint;\n    void main(){\n      vTint = aTint;\n      vec4 mv = modelViewMatrix * vec4(position, 1.0);\n      gl_PointSize = (aSize * aBoost) * (300.0 / -mv.z) + uPointSizePx;\n      gl_Position  = projectionMatrix * mv;\n    }\n  ",fragmentShader:"\n    precision highp float;\n    varying vec3  vTint;\n    void main(){\n      vec2 d = gl_PointCoord * 2.0 - 1.0;\n      float r2 = dot(d,d);\n      if (r2 > 1.0) discard;\n      float a = smoothstep(1.0, 0.7, r2);\n      gl_FragColor = vec4(vTint, a);\n    }\n  ",transparent:!0,depthWrite:!1}),pointsField=new THREE.Points(pGeo,pMat),particlesParent.add(pointsField),AmbientFlow.createEmitter()}function particlesOnFrame(e){if(!(pGeo&&pMat&&renderer&&camera))return;AmbientFlow.createEmitter(),AmbientFlow.updateEmitter(e),AmbientFlow.spawnLoop(e);const t=pGeo.getAttribute("position"),a=pGeo.getAttribute("seed"),n=pGeo.getAttribute("aBoost"),r=pGeo.getAttribute("aTint"),o=pGeo.getAttribute("aBaseTint"),s=renderer.domElement.width,i=renderer.domElement.height,l=params?.particleSpeedScale??.9,c=params?.particleSwirl??.5,u=params?.particleDamping??.9,d=new THREE.Color(1,.95,.2),p=mousePx&&mousePx.x>=0&&mousePx.y>=0,m=p?mousePx.clientX:0,f=p?mousePx.clientY:0,h=new THREE.Vector3(0,1.15,0),g=new THREE.Vector3(0,1,0),v=new THREE.Vector3,y=new THREE.Vector3,b=new THREE.Vector3;for(let n=0;n<P_COUNT;n++){const r=3*n,o=a.getZ(n)+e*a.getY(n)*l;a.setZ(n,o);const s=t.array[r],i=t.array[r+1],u=t.array[r+2];v.set(s,i,u).sub(h);const d=v.length();if(d>1e-4){const t=v.multiplyScalar(1/d);b.crossVectors(t,g).normalize(),vel[r]+=b.x*c*e,vel[r+1]+=b.y*c*e*AmbientFlow.config.swirlYFactor,vel[r+2]+=b.z*c*e,vel[r]+=.08*Math.cos(1.3*o)*e,vel[r+2]+=.08*Math.sin(1.1*o)*e}}if(p)for(let a=0;a<P_COUNT;a++){const l=3*a,c=t.array[l],u=t.array[l+1],p=t.array[l+2];y.set(c,u,p).project(camera);const h=(.5*y.x+.5)*s,g=(.5*y.y+.5)*i,v=h-mousePx.x,b=g-mousePx.y;if(v*v+b*b<=6400){n.array[a]=Math.min(100,n.array[a]+6*e),r.array[l+0]+=(d.r-r.array[l+0])*Math.min(1,6*e),r.array[l+1]+=(d.g-r.array[l+1])*Math.min(1,6*e),r.array[l+2]+=(d.b-r.array[l+2])*Math.min(1,6*e);const t=pointerWorldAtY(m,f,u),o=16*(t.x-c)-4*vel[l],s=16*(t.z-p)-4*vel[l+2];vel[l]+=o*e,vel[l+2]+=s*e}else n.array[a]=Math.max(1,n.array[a]-3*e),r.array[l+0]+=(o.array[l+0]-r.array[l+0])*Math.min(1,3*e),r.array[l+1]+=(o.array[l+1]-r.array[l+1])*Math.min(1,3*e),r.array[l+2]+=(o.array[l+2]-r.array[l+2])*Math.min(1,3*e)}else for(let t=0;t<P_COUNT;t++){const a=3*t;n.array[t]=Math.max(1,n.array[t]-2*e),r.array[a+0]+=(o.array[a+0]-r.array[a+0])*Math.min(1,2*e),r.array[a+1]+=(o.array[a+1]-r.array[a+1])*Math.min(1,2*e),r.array[a+2]+=(o.array[a+2]-r.array[a+2])*Math.min(1,2*e)}const w=AmbientFlow.state.mesh.position,E=AmbientFlow.config.returnGain,S=AmbientFlow.config.returnGainY,x=AmbientFlow.config.recycleRadius2;for(let a=0;a<P_COUNT;a++)if(AmbientFlow.state.life[a]-=e,AmbientFlow.state.life[a]<=0){const n=3*a,r=t.array[n],o=t.array[n+1],s=t.array[n+2],i=w.x-r,l=w.y-o,c=w.z-s;vel[n]+=i*E*e,vel[n+1]+=l*E*S*e,vel[n+2]+=c*E*e,i*i+l*l+c*c<x&&(AmbientFlow.state.life[a]=0)}for(let a=0;a<P_COUNT;a++){const n=3*a;t.array[n]+=vel[n]*e,t.array[n+1]+=vel[n+1]*e,t.array[n+2]+=vel[n+2]*e,vel[n]*=u,vel[n+1]*=u,vel[n+2]*=u}t.needsUpdate=!0,a.needsUpdate=!0,n.needsUpdate=!0,r.needsUpdate=!0,pMat.uniforms&&pMat.uniforms.uPointSizePx&&(pMat.uniforms.uPointSizePx.value=0)}buildParticles(P_COUNT);const params={renderMode:"solid",saturation:1,pointSize:2.2,pcAudioReact:!0,pcReactAmount:.8,rotationSpeed:.25,displacement_amp:.22,noise_freq:1.2,tex_strength:1,reflection_alpha:.55,pool_radius:1.6,pool_softness:1.2,wobble_amp:.015,wobble_freq:1.6,top_reflection_alpha:.35,top_pool_radius:1.4,top_pool_softness:.9,particles:P_COUNT,particleSpeedScale:.9,particlePushStrength:5,particleMargin:.08,particleDamping:.9,particleSwirl:.5,spectrumMode:"points",spectrumSize:10,spectrumRadius:2,spectrumHeight:.9,spectrumGain:1,spectrumHueShift:0,spectrumShape:"circle",autoShowBands:!0,showThreshold:.04,showSmoothing:.85,star_count:2e4,star_radius:150,star_thickness:50,star_color:14542591,star_size:1.2,star_sizeJitter:.8,star_opacity:1,star_noiseScale:.08,star_noiseBias:.15,star_noiseStrength:.85,star_noiseDisplace:2,star_twinkleSpeed:.6,star_twinkleAmount:.35,star_driftSpeed:.002,star_seed:42,star_nebulaEnabled:!0,star_nebulaAmount:.3,star_nebulaScale:.015,star_nebulaBias:.5,star_nebulaSmooth:.2,star_nebulaColorA:10467839,star_nebulaColorB:16754342,star_bgEnabled:!0,star_bgScale:3,star_bgThreshold:.69,star_bgFalloff:.12,star_bgPower:1,star_bgVignette:.5,star_bgColorA:8036607,star_bgColorB:16748448};function applyParamSideEffects(e,t){if(!/^star_/.test(e))return;const a={};switch(e){case"star_count":a.count=0|t;break;case"star_radius":a.radius=+t;break;case"star_thickness":a.thickness=+t;break;case"star_color":a.color=t;break;case"star_size":a.size=+t;break;case"star_sizeJitter":a.sizeJitter=+t;break;case"star_opacity":a.opacity=+t;break;case"star_noiseScale":a.noiseScale=+t;break;case"star_noiseBias":a.noiseBias=+t;break;case"star_noiseStrength":a.noiseStrength=+t;break;case"star_noiseDisplace":a.noiseDisplace=+t;break;case"star_twinkleSpeed":a.twinkleSpeed=+t;break;case"star_twinkleAmount":a.twinkleAmount=+t;break;case"star_driftSpeed":a.driftSpeed=+t;break;case"star_seed":a.seed=null==t||""===t?null:0|t;break;case"star_nebulaEnabled":a.nebulaEnabled=!!t;break;case"star_nebulaAmount":a.nebulaAmount=+t;break;case"star_nebulaScale":a.nebulaScale=+t;break;case"star_nebulaBias":a.nebulaBias=+t;break;case"star_nebulaSmooth":a.nebulaSmooth=+t;break;case"star_nebulaColorA":a.nebulaColorA=t;break;case"star_nebulaColorB":a.nebulaColorB=t;break;case"star_bgEnabled":a.bgEnabled=!!t;break;case"star_bgScale":a.bgScale=+t;break;case"star_bgThreshold":a.bgThreshold=+t;break;case"star_bgFalloff":a.bgFalloff=+t;break;case"star_bgPower":a.bgPower=+t;break;case"star_bgVignette":a.bgVignette=+t;break;case"star_bgColorA":a.bgColorA=t;break;case"star_bgColorB":a.bgColorB=t}Starfield.configure(a)}function applyStarfieldFromParams(){Starfield.configure({count:0|params.star_count,radius:+params.star_radius,thickness:+params.star_thickness,color:params.star_color,size:+params.star_size,sizeJitter:+params.star_sizeJitter,opacity:+params.star_opacity,noiseScale:+params.star_noiseScale,noiseBias:+params.star_noiseBias,noiseStrength:+params.star_noiseStrength,noiseDisplace:+params.star_noiseDisplace,twinkleSpeed:+params.star_twinkleSpeed,twinkleAmount:+params.star_twinkleAmount,driftSpeed:+params.star_driftSpeed,seed:null==params.star_seed||""===params.star_seed?null:0|params.star_seed,nebulaEnabled:!!params.star_nebulaEnabled,nebulaAmount:+params.star_nebulaAmount,nebulaScale:+params.star_nebulaScale,nebulaBias:+params.star_nebulaBias,nebulaSmooth:+params.star_nebulaSmooth,nebulaColorA:params.star_nebulaColorA,nebulaColorB:params.star_nebulaColorB,bgEnabled:!!params.star_bgEnabled,bgScale:+params.star_bgScale,bgThreshold:+params.star_bgThreshold,bgFalloff:+params.star_bgFalloff,bgPower:+params.star_bgPower,bgVignette:+params.star_bgVignette,bgColorA:params.star_bgColorA,bgColorB:params.star_bgColorB})}!function(){try{const e=Starfield?.config;if(!e)return;params.star_count=e.count,params.star_radius=e.radius,params.star_thickness=e.thickness,params.star_color=e.color,params.star_size=e.size,params.star_sizeJitter=e.sizeJitter,params.star_opacity=e.opacity,params.star_noiseScale=e.noiseScale,params.star_noiseBias=e.noiseBias,params.star_noiseStrength=e.noiseStrength,params.star_noiseDisplace=e.noiseDisplace,params.star_twinkleSpeed=e.twinkleSpeed,params.star_twinkleAmount=e.twinkleAmount,params.star_driftSpeed=e.driftSpeed,params.star_seed=e.seed,params.star_nebulaEnabled=e.nebulaEnabled,params.star_nebulaAmount=e.nebulaAmount,params.star_nebulaScale=e.nebulaScale,params.star_nebulaBias=e.nebulaBias,params.star_nebulaSmooth=e.nebulaSmooth,params.star_nebulaColorA=e.nebulaColorA,params.star_nebulaColorB=e.nebulaColorB,params.star_bgEnabled=e.bgEnabled,params.star_bgScale=e.bgScale,params.star_bgThreshold=e.bgThreshold,params.star_bgFalloff=e.bgFalloff,params.star_bgPower=e.bgPower,params.star_bgVignette=e.bgVignette,params.star_bgColorA=e.bgColorA,params.star_bgColorB=e.bgColorB}catch(e){}}();const gui=new GUI({title:"Blob Controls"});syncGuiFromParams();const f0=gui.addFolder("Render / Look");f0.add(params,"renderMode",["solid","wireframe","points"]).name("Render Mode").onChange(e=>{const t="points"===e;sphere.visible=!t,sphereMat.wireframe="wireframe"===e,spherePoints.visible=t}),f0.add(params,"saturation",0,2,.01).name("Saturation").onChange(e=>{sphereMat.uniforms.uSaturation.value=e,reflectMatBottom.uniforms.uSaturation.value=e,reflectMatTop.uniforms.uSaturation.value=e,spherePointsMat.uniforms.uSaturation.value=e}),f0.add(params,"pointSize",.05,.45,.005).name("Point Size (PC)");const fPC=gui.addFolder("Point Cloud Audio React");fPC.add(params,"pcAudioReact").name("Enable"),fPC.add(params,"pcReactAmount",0,3,.01).name("Amount");const f1=gui.addFolder("Deformation");f1.add(params,"rotationSpeed",0,2,.01).name("Rotation Speed"),f1.add(params,"displacement_amp",0,.8,.005).name("Displacement Amp").onChange(e=>{sphereMat.uniforms.uAmp.value=e,reflectMatBottom.uniforms.uAmp.value=e,reflectMatTop.uniforms.uAmp.value=e,spherePointsMat.uniforms.uAmp.value=e}),f1.add(params,"noise_freq",.1,4,.01).name("Noise Freq").onChange(e=>{sphereMat.uniforms.uFreq.value=e,reflectMatBottom.uniforms.uFreq.value=e,reflectMatTop.uniforms.uFreq.value=e,spherePointsMat.uniforms.uFreq.value=e}),f1.add(params,"tex_strength",0,3,.01).name("Media Strength").onChange(e=>{sphereMat.uniforms.uTexStrength.value=e,reflectMatBottom.uniforms.uTexStrength.value=e,reflectMatTop.uniforms.uTexStrength.value=e,spherePointsMat.uniforms.uTexStrength.value=e});const f2=gui.addFolder("Bottom Reflector / Floor");f2.add(params,"reflection_alpha",0,1,.01).name("Opacity").onChange(e=>{reflectMatBottom.uniforms.uAlpha.value=e}),f2.add(params,"pool_radius",.2,5,.01).name("Bright Radius").onChange(e=>{reflectMatBottom.uniforms.uR.value=e}),f2.add(params,"pool_softness",.1,3,.01).name("Fade Softness").onChange(e=>{reflectMatBottom.uniforms.uSoft.value=e}),f2.add(params,"wobble_amp",0,.05,.001).name("Surface Wobble Amp").onChange(e=>{reflectMatBottom.uniforms.uWobbleAmp.value=e,reflectMatTop.uniforms.uWobbleAmp.value=e}),f2.add(params,"wobble_freq",.1,4,.01).name("Surface Wobble Freq").onChange(e=>{reflectMatBottom.uniforms.uWobbleFreq.value=e,reflectMatTop.uniforms.uWobbleFreq.value=e});const f2b=gui.addFolder("Top Reflector / Ceiling");f2b.add(params,"top_reflection_alpha",0,1,.01).name("Opacity").onChange(e=>{reflectMatTop.uniforms.uAlpha.value=e}),f2b.add(params,"top_pool_radius",.2,5,.01).name("Bright Radius").onChange(e=>{reflectMatTop.uniforms.uR.value=e}),f2b.add(params,"top_pool_softness",.1,3,.01).name("Fade Softness").onChange(e=>{reflectMatTop.uniforms.uSoft.value=e});const f3=gui.addFolder("Ambient Particles");f3.add(params,"particles",0,3e4,50).name("Count").onFinishChange(e=>{buildParticles(Math.max(0,Math.floor(e)))}),f3.add(params,"particleSpeedScale",0,3,.01).name("Speed Scale"),f3.add(params,"particleSwirl",0,2,.01).name("Swirl"),f3.add(params,"particlePushStrength",0,20,.1).name("Push Strength"),f3.add(params,"particleMargin",0,.3,.005).name("Surface Margin"),f3.add(params,"particleDamping",.7,.99,.001).name("Damping");const f4=gui.addFolder("Spectrum (Audio)");f4.add(params,"spectrumMode",["points","line"]).name("Mode"),f4.add(params,"spectrumShape",["circle","square","triangle","cross"]).name("Point Shape").onChange(e=>{specMat.uniforms.uShape.value={circle:0,square:1,triangle:2,cross:3}[e]??0}),f4.add(params,"spectrumSize",2,24,.1).name("Point Size"),f4.add(params,"spectrumRadius",1.2,3.5,.01).name("Radius"),f4.add(params,"spectrumHeight",.2,2,.01).name("Height Scale"),f4.add(params,"spectrumGain",.2,4,.01).name("Gain"),f4.add(params,"spectrumHueShift",0,1,.001).name("Hue Shift"),f4.add(params,"autoShowBands").name("Auto Show When Audio"),f4.add(params,"showThreshold",0,.2,.001).name("Show Threshold"),f4.add(params,"showSmoothing",.5,.99,.001).name("Show Smooth"),function e(){let t=!0;if(!t||!gui)return void queueMicrotask(e);const a=gui.addFolder("Starfield");a.close();const n=a.addFolder("Distribution");n.close();const r=a.addFolder("Appearance");r.close();const o=a.addFolder("Motion / Twinkle");o.close();const s=a.addFolder("Nebula (per-star)");s.close();const i=a.addFolder("Background Sky");i.close();const l=a.addFolder("Randomness");l.close(),n.add(params,"star_count",0,1e5,100).name("Count").onChange(e=>{applyParamSideEffects("star_count",e),schedulePersist()}).listen(),n.add(params,"star_radius",1,2e3,1).name("Radius").onChange(e=>{applyParamSideEffects("star_radius",e),schedulePersist()}).listen(),n.add(params,"star_thickness",0,1e3,1).name("Thickness").onChange(e=>{applyParamSideEffects("star_thickness",e),schedulePersist()}).listen(),r.addColor(params,"star_color").name("Tint").onChange(e=>{applyParamSideEffects("star_color",e),schedulePersist()}).listen(),r.add(params,"star_size",.1,6,.01).name("Size").onChange(e=>{applyParamSideEffects("star_size",e),schedulePersist()}).listen(),r.add(params,"star_sizeJitter",0,2,.01).name("Size Jitter").onChange(e=>{applyParamSideEffects("star_sizeJitter",e),schedulePersist()}).listen(),r.add(params,"star_opacity",0,1,.01).name("Opacity").onChange(e=>{applyParamSideEffects("star_opacity",e),schedulePersist()}).listen(),n.add(params,"star_noiseScale",.001,1,.001).name("Noise Scale").onChange(e=>{applyParamSideEffects("star_noiseScale",e),schedulePersist()}).listen(),n.add(params,"star_noiseBias",0,1,.001).name("Noise Bias").onChange(e=>{applyParamSideEffects("star_noiseBias",e),schedulePersist()}).listen(),n.add(params,"star_noiseStrength",0,2,.001).name("Noise Strength").onChange(e=>{applyParamSideEffects("star_noiseStrength",e),schedulePersist()}).listen(),n.add(params,"star_noiseDisplace",0,6,.01).name("Noise Displace").onChange(e=>{applyParamSideEffects("star_noiseDisplace",e),schedulePersist()}).listen(),o.add(params,"star_twinkleSpeed",0,4,.01).name("Twinkle Speed").onChange(e=>{applyParamSideEffects("star_twinkleSpeed",e),schedulePersist()}).listen(),o.add(params,"star_twinkleAmount",0,1,.001).name("Twinkle Amount").onChange(e=>{applyParamSideEffects("star_twinkleAmount",e),schedulePersist()}).listen(),o.add(params,"star_driftSpeed",0,.1,5e-4).name("Drift Speed").onChange(e=>{applyParamSideEffects("star_driftSpeed",e),schedulePersist()}).listen(),s.add(params,"star_nebulaEnabled").name("Enable").onChange(e=>{applyParamSideEffects("star_nebulaEnabled",e),schedulePersist()}).listen(),s.add(params,"star_nebulaAmount",0,1,.001).name("Amount").onChange(e=>{applyParamSideEffects("star_nebulaAmount",e),schedulePersist()}).listen(),s.add(params,"star_nebulaScale",.001,.2,.001).name("Scale").onChange(e=>{applyParamSideEffects("star_nebulaScale",e),schedulePersist()}).listen(),s.add(params,"star_nebulaBias",0,1,.001).name("Bias").onChange(e=>{applyParamSideEffects("star_nebulaBias",e),schedulePersist()}).listen(),s.add(params,"star_nebulaSmooth",0,1,.001).name("Smooth").onChange(e=>{applyParamSideEffects("star_nebulaSmooth",e),schedulePersist()}).listen(),s.addColor(params,"star_nebulaColorA").name("Color A").onChange(e=>{applyParamSideEffects("star_nebulaColorA",e),schedulePersist()}).listen(),s.addColor(params,"star_nebulaColorB").name("Color B").onChange(e=>{applyParamSideEffects("star_nebulaColorB",e),schedulePersist()}).listen(),i.add(params,"star_bgEnabled").name("Enabled").onChange(e=>{applyParamSideEffects("star_bgEnabled",e),schedulePersist()}).listen(),i.add(params,"star_bgScale",.001,6,.001).name("Scale").onChange(e=>{applyParamSideEffects("star_bgScale",e),schedulePersist()}).listen(),i.add(params,"star_bgThreshold",0,1,.001).name("Threshold").onChange(e=>{applyParamSideEffects("star_bgThreshold",e),schedulePersist()}).listen(),i.add(params,"star_bgFalloff",0,1,.001).name("Edge Falloff").onChange(e=>{applyParamSideEffects("star_bgFalloff",e),schedulePersist()}).listen(),i.add(params,"star_bgPower",.1,4,.01).name("Core Power").onChange(e=>{applyParamSideEffects("star_bgPower",e),schedulePersist()}).listen(),i.add(params,"star_bgVignette",0,1.5,.01).name("Vignette").onChange(e=>{applyParamSideEffects("star_bgVignette",e),schedulePersist()}).listen(),i.addColor(params,"star_bgColorA").name("Sky Color A").onChange(e=>{applyParamSideEffects("star_bgColorA",e),schedulePersist()}).listen(),i.addColor(params,"star_bgColorB").name("Sky Color B").onChange(e=>{applyParamSideEffects("star_bgColorB",e),schedulePersist()}).listen();const c={seed:null==params.star_seed?"":String(params.star_seed)};l.add(c,"seed").name("Seed (int or empty)").onFinishChange(e=>{const t="string"==typeof e&&""===e.trim()?null:Number.isFinite(+e)?0|e:null;params.star_seed=t,applyParamSideEffects("star_seed",t),c.seed=null==params.star_seed?"":String(params.star_seed),schedulePersist()}).listen();("function"==typeof a.controllersRecursive?a.controllersRecursive():a.controllers||[]).forEach(e=>{"function"==typeof e.listen&&e.listen()})}(),function(){if(void 0===AmbientFlow||!gui)return;AmbientFlow.config.orbit=AmbientFlow.config.orbit||{};const e=AmbientFlow.config,t=e=>{AmbientFlow.configure(e)},a=()=>{if(e.lifeMin>e.lifeMax){const t=e.lifeMin;e.lifeMin=e.lifeMax,e.lifeMax=t}},n=gui.addFolder("Ambient Flow");n.close();const r=n.addFolder("Emission");r.close();const o=n.addFolder("Spawn");o.close();const s=n.addFolder("Orbit");s.close();const i=n.addFolder("Return");i.close();const l=n.addFolder("Randomness");l.close(),r.add(e,"emitRate",0,300,1).name("Emit Rate (pps)").onChange(e=>t({emitRate:e})).listen(),r.add(e,"lifeMin",.1,20,.05).name("Life Min (s)").onChange(()=>{a(),t({lifeMin:e.lifeMin,lifeMax:e.lifeMax})}).listen(),r.add(e,"lifeMax",.1,20,.05).name("Life Max (s)").onChange(()=>{a(),t({lifeMin:e.lifeMin,lifeMax:e.lifeMax})}).listen(),o.add(e,"spawnJitter",0,.1,.001).name("Spawn Jitter (m)").onChange(e=>t({spawnJitter:e})).listen(),o.add(e,"kickSpeed",0,2,.01).name("Kick Speed").onChange(e=>t({kickSpeed:e})).listen(),o.add(e,"kickY",0,1,.01).name("Kick Y").onChange(e=>t({kickY:e})).listen(),o.add(e,"kickSpread",0,3,.01).name("Kick Spread").onChange(e=>t({kickSpread:e})).listen(),s.add(e.orbit,"rBase",.2,4,.01).name("Radius Base").onChange(e=>t({orbit:{rBase:e}})).listen(),s.add(e.orbit,"rAmp1",0,2,.01).name("Radius Amp 1").onChange(e=>t({orbit:{rAmp1:e}})).listen(),s.add(e.orbit,"rFreq1",0,3,.01).name("Radius Freq 1").onChange(e=>t({orbit:{rFreq1:e}})).listen(),s.add(e.orbit,"rAmp2",0,2,.01).name("Radius Amp 2").onChange(e=>t({orbit:{rAmp2:e}})).listen(),s.add(e.orbit,"rFreq2",0,3,.01).name("Radius Freq 2").onChange(e=>t({orbit:{rFreq2:e}})).listen(),s.add(e.orbit,"angSpeed",0,3,.01).name("Angle Speed").onChange(e=>t({orbit:{angSpeed:e}})).listen(),s.add(e.orbit,"angOscAmp",0,2,.01).name("Angle Osc Amp").onChange(e=>t({orbit:{angOscAmp:e}})).listen(),s.add(e.orbit,"angOscFreq",0,3,.01).name("Angle Osc Freq").onChange(e=>t({orbit:{angOscFreq:e}})).listen(),s.add(e.orbit,"yBase",0,3,.01).name("Y Base").onChange(e=>t({orbit:{yBase:e}})).listen(),s.add(e.orbit,"yAmp",0,2,.01).name("Y Amp").onChange(e=>t({orbit:{yAmp:e}})).listen(),s.add(e.orbit,"yOsc1",0,3,.01).name("Y Freq 1").onChange(e=>t({orbit:{yOsc1:e}})).listen(),s.add(e.orbit,"yOsc2",0,3,.01).name("Y Freq 2").onChange(e=>t({orbit:{yOsc2:e}})).listen(),i.add(e,"returnGain",0,60,.5).name("Return Gain").onChange(e=>t({returnGain:e})).listen(),i.add(e,"returnGainY",0,2,.01).name("Return Gain Y").onChange(e=>t({returnGainY:e})).listen(),i.add(e,"swirlYFactor",0,1,.01).name("Swirl Y Factor").onChange(e=>t({swirlYFactor:e})).listen();const c={seed:null==e.seed?"":String(e.seed)};l.add(c,"seed").name("Seed (int or empty)").onFinishChange(e=>{const t="string"==typeof e&&""===e.trim()?null:Number.isFinite(+e)?0|e:null;AmbientFlow.setSeed(t),c.seed=null==AmbientFlow.config.seed?"":String(AmbientFlow.config.seed)}).listen();("function"==typeof n.controllersRecursive?n.controllersRecursive():n.controllers||[]).forEach(e=>{"function"==typeof e.listen&&e.listen()})}(),gui.close();{const e="function"==typeof gui?.controllersRecursive?gui.controllersRecursive():Array.isArray(gui?.controllers)?gui.controllers:[];for(const t of e)"function"==typeof t.listen&&t.listen()}function _g(...e){console.log("[GUI]",...e)}function _warn(...e){console.warn("[GUI]",...e)}function findControllerByName(e,t){if(!e)return null;const a="function"==typeof e.controllersRecursive?e.controllersRecursive():function e(t){const a=[],n=[].concat(t.controllers||[]).concat(t.__controllers||[]).concat(t._controllers||[]);for(const e of n)a.push(e);const r=[].concat(t.folders||[]).concat(t.__folders||[]).concat(t._folders||[]).concat(t.children||[]);for(const t of r)if(Array.isArray(t))for(const n of t)a.push(...e(n));else t&&"object"==typeof t&&a.push(...e(t));return a}(e);for(const e of a){const a=e._property??e.property??e._name,n=e._name??e.name;if(a===t||n===t)return e}return null}function setParamAndGui(e,t){const a=params[e];params[e]=t;const n=findControllerByName(gui,e);if(n)try{n.setValue(t),"function"==typeof n.updateDisplay&&n.updateDisplay(),_g("setParamAndGui",{name:e,from:a,to:t})}catch(a){_warn("setParamAndGui#setValue failed",{name:e,error:a});try{"function"==typeof applyParamSideEffects&&applyParamSideEffects(e,t)}catch(e){}}else{try{"function"==typeof applyParamSideEffects&&applyParamSideEffects(e,t)}catch(e){}_g("setParamAndGui (no controller)",{name:e,value:t})}"function"==typeof schedulePersist&&schedulePersist()}function syncGuiFromParams(){if(!gui)return void _warn("syncGuiFromParams: gui not ready");let e=0,t=0,a=0;for(const[n,r]of Object.entries(params)){const o=findControllerByName(gui,n);if(o)try{o.setValue(r),"function"==typeof o.updateDisplay&&o.updateDisplay(),e++}catch(e){a++,_warn("syncGuiFromParams#failed",{key:n,error:e})}else t++}_g("syncGuiFromParams",{updated:e,missing:t,failed:a})}function snapshotSettings(e="preset"){return{name:e,ts:Date.now(),params:{...params},camera:{position:[camera.position.x,camera.position.y,camera.position.z],target:[controls.target.x,controls.target.y,controls.target.z]}}}function applySettings(e){if(!e||!e.params||!e.camera)return void _warn("applySettings: invalid snapshot");console.group("[Restore] applySettings",e.name??"");let t=0,a=0;for(const[n,r]of Object.entries(e.params))n in params?(setParamAndGui(n,r),t++):(a++,_warn("applySettings: unknown param (ignored)",n));const n=Array.isArray(e.camera.position)?e.camera.position:[0,1.6,3.5],r=Array.isArray(e.camera.target)?e.camera.target:[0,.9,0];camera.position.set(n[0],n[1],n[2]),controls.target.set(r[0],r[1],r[2]),camera.updateProjectionMatrix(),controls.update(),syncGuiFromParams();try{applyStarfieldFromParams()}catch(e){}let o=0;const s=[],i="function"==typeof gui?.controllersRecursive?gui.controllersRecursive():[];for(const e of i){const t=e._property??e.property??e._name;if(!(t in params))continue;const a="function"==typeof e.getValue?e.getValue():e._object?e._object[e._property]:void 0,n=params[t];a===n||Number.isFinite(a)&&Number.isFinite(n)&&Math.abs(a-n)<1e-9||(o++,s.push({key:t,guiVal:a,modelVal:n}))}s.length&&console.table(s),_g("applySettings summary",{setCount:t,skipped:a,mismatches:o}),console.groupEnd()}var __persistTimer=0;const __LS_OK=function(){try{const e="__ls_probe__"+Math.random().toString(36).slice(2);return localStorage.setItem(e,"1"),localStorage.removeItem(e),!0}catch(e){return!1}}();function persistNow(){if(__LS_OK)try{const e={ts:Date.now(),params:{...params},camera:{position:[camera.position.x,camera.position.y,camera.position.z],target:[controls.target.x,controls.target.y,controls.target.z]},media:playlist&&Number.isInteger(currentIndex)?{index:currentIndex,url:playlist[currentIndex]?.url||playlist[currentIndex]?.src||null}:{index:0},loop:!(void 0===loopChk||!loopChk||!loopChk.checked)};localStorage.setItem(STORAGE_KEY,JSON.stringify(e)),console.log("[GUI] persisted")}catch(e){console.warn("[GUI] persistNow failed",e)}else console.warn("[GUI] localStorage unavailable")}function schedulePersist(){clearTimeout(__persistTimer),__persistTimer=setTimeout(persistNow,120)}async function restoreFromStorageOrPreset(){console.group("[Restore] start");let e=!1;if(__LS_OK)try{const t=localStorage.getItem(STORAGE_KEY);if(t){const a=JSON.parse(t);a?.params&&a?.camera&&(applySettings(a),"boolean"==typeof a.loop&&void 0!==loopChk&&loopChk&&(loopChk.checked=a.loop),a.media&&Number.isInteger(a.media.index)&&(currentIndex=Math.max(0,Math.min(0|a.media.index,Math.max(0,playlist.length-1)))),"function"==typeof refreshPlaylistSelect&&refreshPlaylistSelect(),e=!0,console.log("[GUI] restored from localStorage"))}}catch(e){console.warn("[GUI] restore localStorage parse error",e)}else console.warn("[GUI] localStorage unavailable (private mode / blocked)");if(!e&&"function"==typeof fetch)try{const e=await fetch("presets/default.json",{cache:"no-store"});if(e.ok){const t=await e.json();t?.params&&t?.camera&&(applySettings(t),t.media&&Number.isInteger(t.media.index)&&(currentIndex=Math.max(0,Math.min(0|t.media.index,Math.max(0,playlist.length-1)))),"function"==typeof refreshPlaylistSelect&&refreshPlaylistSelect(),console.log("[GUI] restored default.json"))}}catch(e){console.warn("[GUI] default preset fetch error",e)}console.groupEnd()}const presetFileInput=document.getElementById("presetFile");presetFileInput?.addEventListener("change",async e=>{const t=e.target.files?.[0];if(t)try{const e=await t.text(),a=JSON.parse(e);_g("apply from file",t.name),applySettings(a)}catch(e){_warn("file load failed",e)}finally{presetFileInput.value=""}});const fPresets=gui.addFolder("Presets");fPresets.add({save:()=>{const e=prompt("Preset name:","preset")||"preset",t=snapshotSettings(e),a=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),n=document.createElement("a"),r=(new Date).toISOString().replace(/[:.]/g,"-");n.href=URL.createObjectURL(a),n.download=`player-settings-${r}-${e}.json`,document.body.appendChild(n),n.click(),setTimeout(()=>{URL.revokeObjectURL(n.href),n.remove()},0),_g("saved file",n.download)}},"save").name("Save to file"),fPresets.add({load:()=>{presetFileInput.click()}},"load").name("Load from file"),fPresets.open(),queueMicrotask(()=>{try{controls?.addEventListener?.("change",schedulePersist)}catch(e){}}),window.addEventListener("beforeunload",persistNow),applyUIVisibility();let controls=new OrbitControls(camera,renderer.domElement);controls.enableDamping=!0,controls.enablePan=!1,controls.minDistance=.1,controls.maxDistance=24,controls.target.set(0,.9,0),controls.addEventListener("change",schedulePersist);const probeCanvas=document.createElement("canvas"),probeCtx=probeCanvas.getContext("2d",{willReadFrequently:!0});probeCanvas.width=128,probeCanvas.height=128;let probePixels=null;function updateProbe(){if(probeCtx&&probeCanvas){if("webcam"===source.type||"video"===source.type){const e=source.videoEl;if(!e||e.readyState<2||0===e.videoWidth||0===e.videoHeight)return void(probePixels=null);probeCtx.drawImage(e,0,0,probeCanvas.width,probeCanvas.height)}else if("image"===source.type){const e=source.imageEl;if(!e)return void(probePixels=null);probeCtx.drawImage(e,0,0,probeCanvas.width,probeCanvas.height)}else{if("audio"!==source.type)return void(probePixels=null);{const e=source.spectrumCanvas;if(!e)return void(probePixels=null);probeCtx.drawImage(e,0,0,probeCanvas.width,probeCanvas.height)}}try{probePixels=probeCtx.getImageData(0,0,probeCanvas.width,probeCanvas.height).data}catch(e){console.warn("[Probe] getImageData failed",e),probePixels=null}}else probePixels=null}function dirToUV(e){return{u:.5+Math.atan2(e.z,e.x)/(2*Math.PI),v:.5+Math.asin(THREE.MathUtils.clamp(e.y,-1,1))/Math.PI}}const center=new THREE.Vector3(0,1.15,0),tmp=new THREE.Vector3,up=new THREE.Vector3(0,1,0),cpuSimplex=new SimplexNoise;function displacedRadiusAtDir(e,t){const a=sphereMat.uniforms.uFreq.value,n=sphereMat.uniforms.uAmp.value,r=sphereMat.uniforms.uTexStrength.value,o=cpuSimplex.noise3d(e.x*a,e.y*a+.25*t,e.z*a)*(.35*n);let s=0;if(1===sphereMat.uniforms.uUseTex.value&&probePixels){const{u:t,v:a}=dirToUV(new THREE.Vector3(-e.x,e.y,e.z)),o=Math.min(probeCanvas.width-1,Math.max(0,Math.floor(t*probeCanvas.width))),i=4*(Math.min(probeCanvas.height-1,Math.max(0,Math.floor(a*probeCanvas.height)))*probeCanvas.width+o);s=1.35*n*(.5-(.2126*(probePixels[i]/255)+.7152*(probePixels[i+1]/255)+.0722*(probePixels[i+2]/255)))*r}return 1+THREE.MathUtils.clamp(o+s,1.35*-n,1.35*n)}addEventListener("resize",()=>{camera.aspect=container.clientWidth/container.clientHeight,camera.updateProjectionMatrix(),renderer.setSize(container.clientWidth,container.clientHeight),particlesOnResize()});const Starfield=(()=>{const e={parent:null,points:null,geom:null,mat:null,bgMesh:null,bgGeom:null,bgMat:null,t:0,rng:null,config:{count:2e3,radius:40,thickness:20,color:14542591,size:1.2,sizeJitter:.8,opacity:1,noiseScale:.08,noiseBias:.15,noiseStrength:.85,noiseDisplace:2,twinkleSpeed:.6,twinkleAmount:.35,driftSpeed:.002,seed:12345,nebulaEnabled:!0,nebulaAmount:.25,nebulaScale:.015,nebulaBias:.5,nebulaSmooth:.2,nebulaColorA:10467839,nebulaColorB:16754342,bgEnabled:!0,bgScale:.04,bgThreshold:.7,bgFalloff:.1,bgPower:1.8,bgVignette:.25,bgColorA:8036607,bgColorB:16748448}};function t(e){if(null==e)return null;let t=0|e||1;return function(){t|=0,t=t+1831565813|0;let e=Math.imul(t^t>>>15,1|t);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}function a(){return e.rng?e.rng():Math.random()}function n(){return 2*a()-1}function r(e,t,a){const n=Math.max(0,Math.min(1,(a-e)/Math.max(1e-6,t-e)));return n*n*(3-2*n)}const o=(()=>{const e=new Uint8Array(256);function a(a){const n=t(a)||Math.random;for(let t=0;t<256;t++)e[t]=t;for(let t=255;t>0;t--){const a=n()*(t+1)|0,r=e[t];e[t]=e[a],e[a]=r}}a(1337);const n=new Uint8Array(512);function r(){for(let t=0;t<512;t++)n[t]=e[255&t]}return r(),{noise3D:function(e,t,a){const n=Math.floor(e),r=Math.floor(t),o=Math.floor(a),s=e-n,i=t-r,l=a-o,c=s*s*(3-2*s),u=i*i*(3-2*i),d=l*l*(3-2*l);function p(e,t,a){return function(e,t,a){let n=374761393*e^668265263*t^2147483647*a;return n=1274126177*(n^n>>>13),((n^n>>>16)>>>0)/4294967295}(e,t,a)}const m=p(n,r,o),f=p(n+1,r,o),h=p(n,r+1,o),g=p(n+1,r+1,o),v=p(n,r,o+1),y=p(n+1,r,o+1),b=p(n,r+1,o+1),w=m+(f-m)*c,E=v+(y-v)*c,S=w+(h+(g-h)*c-w)*u;return 2*(S+(E+(b+(p(n+1,r+1,o+1)-b)*c-E)*u-S)*d)-1},reseed:function(e){a(null==e?1337:e),r()}}})();function s(s){i(),e.parent=s,e.rng=t(e.config.seed),o.reseed(null==e.config.seed?1337:e.config.seed);const{count:l,radius:c,thickness:u,noiseScale:d,noiseBias:p,noiseStrength:m,noiseDisplace:f,color:h,size:g,sizeJitter:v,opacity:y}=e.config;if(e.config.bgEnabled){const t=1e4;e.bgGeom=new THREE.SphereGeometry(t,64,48);const a=new THREE.Color(e.config.bgColorA),n=new THREE.Color(e.config.bgColorB),r="\n        varying vec3 vDir;\n        void main(){\n          vec4 wp = modelMatrix * vec4(position, 1.0);\n          vDir = normalize(wp.xyz);\n          gl_Position = projectionMatrix * viewMatrix * wp;\n        }\n      ",o="\n        precision highp float;\n        varying vec3 vDir;\n        uniform vec3  uA, uB;\n        uniform float uScale;\n        uniform float uThreshold;\n        uniform float uFalloff;\n        uniform float uPower;\n        uniform float uVignette;\n\n        // value-noise FBM\n        float hash(vec3 p){\n          p = fract(p*0.3183099 + vec3(0.1,0.2,0.3));\n          p *= 17.0;\n          return fract(p.x*p.y*p.z*(p.x+p.y+p.z));\n        }\n        float vnoise(vec3 p){\n          vec3 i=floor(p), f=fract(p);\n          vec3 u=f*f*(3.0-2.0*f);\n          float n000=hash(i+vec3(0,0,0));\n          float n100=hash(i+vec3(1,0,0));\n          float n010=hash(i+vec3(0,1,0));\n          float n110=hash(i+vec3(1,1,0));\n          float n001=hash(i+vec3(0,0,1));\n          float n101=hash(i+vec3(1,0,1));\n          float n011=hash(i+vec3(0,1,1));\n          float n111=hash(i+vec3(1,1,1));\n          float nx00=mix(n000,n100,u.x);\n          float nx10=mix(n010,n110,u.x);\n          float nx01=mix(n001,n101,u.x);\n          float nx11=mix(n011,n111,u.x);\n          float nxy0=mix(nx00,nx10,u.y);\n          float nxy1=mix(nx01,nx11,u.y);\n          return mix(nxy0,nxy1,u.z);\n        }\n        float fbm(vec3 p){\n          float a=0.5,f=1.0,s=0.0;\n          for(int i=0;i<5;i++){ s+=a*vnoise(p*f); f*=2.0; a*=0.5; }\n          return s;\n        }\n        float sstep(float e0,float e1,float x){\n          float t=clamp((x-e0)/max(1e-6,e1-e0),0.0,1.0);\n          return t*t*(3.0-2.0*t);\n        }\n        void main(){\n          vec3 dir = normalize(vDir);\n          float n   = fbm(dir * uScale);\n          float m   = sstep(uThreshold - uFalloff, uThreshold + uFalloff, n);\n          m = pow(m, uPower); // concentrate patch cores\n\n          // gentle horizon darkening; keeps zenith brighter\n          float horizon = pow(max(0.0, dir.y*0.5 + 0.5), uVignette*2.0);\n          float vig = mix(1.0, 0.85, horizon);\n\n          // color inside patches only; outside stays black\n          vec3 cloud = mix(uA, uB, n) * vig;\n          vec3 color = mix(vec3(0.0), cloud, m);\n\n          // opaque write (no blending); draws first; never tints scene\n          gl_FragColor = vec4(color, 1.0);\n        }\n      ";e.bgMat=new THREE.ShaderMaterial({uniforms:{uA:{value:a},uB:{value:n},uScale:{value:e.config.bgScale},uThreshold:{value:e.config.bgThreshold},uFalloff:{value:e.config.bgFalloff},uPower:{value:e.config.bgPower},uVignette:{value:e.config.bgVignette}},vertexShader:r,fragmentShader:o,transparent:!1,depthWrite:!1,depthTest:!1,side:THREE.BackSide,toneMapped:!1}),e.bgMesh=new THREE.Mesh(e.bgGeom,e.bgMat),e.bgMesh.renderOrder=-1e3,e.bgMesh.frustumCulled=!1,e.parent.add(e.bgMesh)}const b=new Float32Array(3*l),w=new Float32Array(l),E=new Float32Array(l),S=new Float32Array(3*l),x=new THREE.Color(h),T=new THREE.Color(e.config.nebulaColorA),C=new THREE.Color(e.config.nebulaColorB);let A=0,_=0,P=20*l;for(;A<l&&_++<P;){let t=n(),s=n(),i=n();const l=Math.hypot(t,s,i)||1;t/=l,s/=l,i/=l;const h=c+((u>0?a():0)-.5)*u;let y=t*h,_=s*h,P=i*h;const M=.5*(o.noise3D(y*d,_*d,P*d)+1),R=m<=0?1:(M-p)*(1/Math.max(1e-6,1-p));if(a()>Math.max(0,Math.min(1,R)))continue;const k=f*(M-.5);y+=t*k,_+=s*k,P+=i*k;const B=3*A;b[B+0]=y,b[B+1]=_,b[B+2]=P;const F=g*(1+v*n());w[A]=Math.max(.1,F),E[A]=a();let L=x.clone();if(e.config.nebulaEnabled){const t=e.config.nebulaScale,a=.5*(o.noise3D(y*t,_*t,P*t)+1),n=e.config.nebulaSmooth,s=r(e.config.nebulaBias-n,e.config.nebulaBias+n,a),i=T.clone().lerp(C,s);L.lerp(i,e.config.nebulaAmount)}S[B+0]=L.r,S[B+1]=L.g,S[B+2]=L.b,A++}const M=A;e.geom=new THREE.BufferGeometry,e.geom.setAttribute("position",new THREE.BufferAttribute(b.subarray(0,3*M),3)),e.geom.setAttribute("aSize",new THREE.BufferAttribute(w.subarray(0,M),1)),e.geom.setAttribute("aPhase",new THREE.BufferAttribute(E.subarray(0,M),1)),e.geom.setAttribute("aColor",new THREE.BufferAttribute(S.subarray(0,3*M),3));e.mat=new THREE.ShaderMaterial({uniforms:{uOpacity:{value:y},uSizeBase:{value:0},uTwinkleAmount:{value:e.config.twinkleAmount},uTwinkleTime:{value:0}},vertexShader:"\n      uniform float uSizeBase;\n      attribute float aSize;\n      attribute float aPhase;\n      attribute vec3  aColor;\n      varying float vPhase;\n      varying vec3  vColor;\n      void main(){\n        vPhase = aPhase;\n        vColor = aColor;\n        vec4 mv = modelViewMatrix * vec4(position, 1.0);\n        float distScale = 300.0 / max(1.0, -mv.z);\n        gl_PointSize = max(1.0, (aSize + uSizeBase) * distScale);\n        gl_Position = projectionMatrix * mv;\n      }\n    ",fragmentShader:"\n      precision highp float;\n      varying vec3  vColor;\n      varying float vPhase;\n      uniform float uOpacity;\n      uniform float uTwinkleAmount;\n      uniform float uTwinkleTime;\n      void main(){\n        vec2 uv = gl_PointCoord * 2.0 - 1.0;\n        float r2 = dot(uv, uv);\n        if (r2 > 1.0) discard;\n        float soft   = 1.0 - smoothstep(0.6, 1.0, r2);\n        float radial = pow(soft, 3.0);\n        float tw     = 0.5 + 0.5 * sin(6.28318 * (uTwinkleTime + vPhase));\n        float twMix  = mix(1.0 - uTwinkleAmount, 1.0, tw);\n        gl_FragColor = vec4(vColor, uOpacity * radial * twMix);\n      }\n    ",transparent:!0,depthWrite:!1}),e.points=new THREE.Points(e.geom,e.mat),e.points.renderOrder=1,e.points.frustumCulled=!1,e.parent.add(e.points)}function i(){e.parent&&e.points&&e.parent.remove(e.points),e.geom&&e.geom.dispose(),e.mat&&e.mat.dispose(),e.parent&&e.bgMesh&&e.parent.remove(e.bgMesh),e.bgGeom&&e.bgGeom.dispose(),e.bgMat&&e.bgMat.dispose(),e.points=e.geom=e.mat=null,e.bgMesh=e.bgGeom=e.bgMat=null}return{create:function(a,n={}){Object.assign(e.config,n),e.rng=t(e.config.seed),s(a)},update:function(t){e.points&&e.mat&&(e.t+=t,e.mat.uniforms.uTwinkleTime.value=e.t*e.config.twinkleSpeed,0!==e.config.driftSpeed&&(e.points.rotation.y+=e.config.driftSpeed*t))},dispose:i,configure:function(a={}){const n=["count","radius","thickness","noiseScale","noiseBias","noiseStrength","noiseDisplace","seed","color","nebulaEnabled","nebulaAmount","nebulaScale","nebulaBias","nebulaSmooth","nebulaColorA","nebulaColorB","bgEnabled","bgScale","bgThreshold","bgFalloff","bgPower","bgVignette"],r=["size","sizeJitter","opacity","twinkleAmount"];let i=!1,l=!1,c=!1;for(const t of Object.keys(a))e.config[t]=a[t],n.includes(t)&&(i=!0),r.includes(t)&&(l=!0),["bgScale","bgThreshold","bgFalloff","bgPower","bgVignette","bgColorA","bgColorB"].includes(t)&&(c=!0);Object.prototype.hasOwnProperty.call(a,"seed")&&(e.rng=t(e.config.seed),o.reseed(null==e.config.seed?1337:e.config.seed),i=!0),i&&e.parent?s(e.parent):(l&&e.mat&&(e.mat.uniforms.uOpacity.value=e.config.opacity,e.mat.uniforms.uTwinkleAmount.value=e.config.twinkleAmount),c&&e.bgMat&&(e.bgMat.uniforms.uScale.value=e.config.bgScale,e.bgMat.uniforms.uThreshold.value=e.config.bgThreshold,e.bgMat.uniforms.uFalloff.value=e.config.bgFalloff,e.bgMat.uniforms.uPower.value=e.config.bgPower,e.bgMat.uniforms.uVignette.value=e.config.bgVignette,e.bgMat.uniforms.uA.value.set(e.config.bgColorA),e.bgMat.uniforms.uB.value.set(e.config.bgColorB)))},state:e,config:e.config}})();Starfield.create(scene,{count:2e4,radius:150,thickness:50,seed:42,nebulaEnabled:!0,nebulaAmount:.3,bgEnabled:!0,bgScale:3,bgThreshold:.69,bgFalloff:.12,bgPower:1,bgVignette:.5});const CameraFly=(()=>{const e={active:!1,mode:0,prevMode:0,t:0,pos:new THREE.Vector3,look:new THREE.Vector3(0,1,0),blend:1,blendDur:1.25,posLerp:.18,lookLerp:.22,lookBlend:1,lookBlendDur:.8,_cancelHandlersAttached:!1,lookObj:null},t=new THREE.Vector3(0,1,0),a=[e=>{const t=1.6+.9*Math.sin(.6*e);return new THREE.Vector3(0,t,1e-4)},e=>{const t=.22*e+.35*Math.sin(.17*e),a=1.6+.25*Math.sin(.27*e);return new THREE.Vector3(3.6*Math.cos(t),a,4.2*Math.sin(t))},e=>{const t=.38*e+.6*Math.sin(.11*e),a=1.3+.45*Math.sin(.63*e)*Math.cos(.21*e);return new THREE.Vector3(2.2*Math.cos(t),a,2.8*Math.sin(t))},e=>{const t=5.2+.6*Math.sin(.2*e),a=.14*e+.25*Math.sin(.07*e),n=2.2+.6*Math.sin(.33*e);return new THREE.Vector3(Math.cos(a)*t,n,Math.sin(a)*t)},e=>{const t=.28*e,a=1.4+1.8*Math.sin(t),n=3.2*Math.cos(t),r=(.6+.25*Math.sin(.2*e))*Math.cos(2*t+.5*Math.sin(.35*e));return new THREE.Vector3(r,a,n)},e=>{const t=.42*e+.2*Math.sin(.5*e),a=1.2+1.2*Math.sin(t),n=2.2*Math.cos(t),r=(.9+.35*Math.sin(.27*e+Math.sin(.13*e)))*Math.sin(2.6*t+.6*Math.sin(.31*e));return new THREE.Vector3(r,a,n)},e=>{const t=.2*e,a=.35*Math.sin(.15*e),n=2.4+.4*Math.sin(.18*e),r=4+.6*Math.sin(.11*e+.3),o=1.6+n*Math.sin(t+a),s=r*Math.cos(t-a),i=(1.2+.5*Math.sin(.22*e)+.2*Math.sin(.47*e))*Math.cos(1.8*t+.8*Math.sin(.19*e));return new THREE.Vector3(i,o,s)},e=>{const t=1.5+1.2*Math.sin(.6*e),a=3.4+.4*Math.sin(.21*e),n=.35*Math.sin(.33*e),r=Math.cos(n)*a,o=Math.sin(n)*a;return new THREE.Vector3(r,t,o)},e=>{const t=6.4+.7*Math.sin(.18*e),a=.1*e+.45*Math.sin(.09*e),n=1.4+.25*Math.sin(.38*e);return new THREE.Vector3(Math.cos(a)*t,n,Math.sin(a)*t)},e=>{const t=3.3+.5*Math.sin(.27*e),a=.26*e+.35*Math.sin(.14*e),n=1.2+.5*Math.sin(.52*e)*Math.cos(.19*e);return new THREE.Vector3(Math.cos(a)*t,n,Math.sin(a)*t)}],n=e=>e<0?0:e>1?1:e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2;function r(a){return 9===a&&void 0!==AmbientFlow&&AmbientFlow.state?.mesh?.position?AmbientFlow.state.mesh.position:1===a&&e.lookObj?e.lookObj.getWorldPosition?e.lookObj.getWorldPosition(new THREE.Vector3):e.lookObj.position:t}function o(t){const n=THREE.MathUtils.clamp(0|t,0,a.length-1),o=r(e.active?e.mode:n)!==r(n)||1===n&&!e.lookObj||1!==n&&1===e.mode;if(!e.active)return e.active=!0,e.mode=n,e.prevMode=n,e.blend=1,e.lookBlend=1,e.t=0,e.pos.copy(camera.position),e.look.copy(r(n)),controls&&(controls.enabled=!1),void function(){if(e._cancelHandlersAttached)return;e._onPointerDown=()=>s(),e._onWheel=()=>s(),renderer.domElement.addEventListener("pointerdown",e._onPointerDown,{passive:!0}),renderer.domElement.addEventListener("wheel",e._onWheel,{passive:!0}),e._cancelHandlersAttached=!0}();n!==e.mode&&(e.prevMode=e.mode,e.mode=n,e.blend=0,e.lookBlend=o?0:e.lookBlend)}function s(){e.active&&(e.active=!1,e.blend=1,e.lookBlend=1,controls&&(controls.enabled=!0),function(){if(!e._cancelHandlersAttached)return;renderer.domElement.removeEventListener("pointerdown",e._onPointerDown),renderer.domElement.removeEventListener("wheel",e._onWheel),e._cancelHandlersAttached=!1}())}return window.addEventListener("keydown",e=>{"0"===e.key?o(0):"1"===e.key?o(1):"2"===e.key?o(2):"3"===e.key?o(3):"4"===e.key?o(4):"5"===e.key?o(5):"6"===e.key?o(6):"7"===e.key?o(7):"8"===e.key?o(8):"9"===e.key?o(9):"Escape"===e.key&&s()}),{start:o,stop:s,update:function(t){if(!e.active)return;e.t+=t;const o=a[e.prevMode](e.t),s=a[e.mode](e.t);e.blend<1&&(e.blend=Math.min(1,e.blend+t/Math.max(1e-4,e.blendDur)));const i=n(e.blend),l=o.lerp(s,i);e.lookBlend<1&&(e.lookBlend=Math.min(1,e.lookBlend+t/Math.max(1e-4,e.lookBlendDur)));const c=n(e.lookBlend),u=r(e.mode),d=1-Math.pow(1-e.posLerp,Math.max(1,Math.round(60*t))),p=(1-Math.pow(1-e.lookLerp,Math.max(1,Math.round(60*t))))*(.35+.65*c);e.pos.lerp(l,d),e.look.lerp(u,p),camera.position.copy(e.pos),camera.lookAt(e.look),controls&&controls.target&&controls.target.copy(e.look)},setLookTarget:function(t){e.lookObj=t&&t.isObject3D?t:null},state:e}})();async function eraseAppData({clearAllLocalStorage:e=!1,reload:t=!0}={}){const a={localStorage:{before:0,after:0,removedKeys:[],clearedAll:!!e,error:null},indexedDB:{deletedNames:[],error:null},caches:{deletedKeys:[],error:null}};try{"undefined"!=typeof persistTimer&&clearTimeout(persistTimer)}catch(e){}try{if(a.localStorage.before=localStorage.length,e){const e=[];for(let t=0;t<localStorage.length;t++)e.push(localStorage.key(t));a.localStorage.removedKeys=e.slice(),localStorage.clear()}else null!==localStorage.getItem(STORAGE_KEY)&&a.localStorage.removedKeys.push(STORAGE_KEY),localStorage.removeItem(STORAGE_KEY);a.localStorage.after=localStorage.length}catch(e){a.localStorage.error=String(e)}try{if(indexedDB&&"function"==typeof indexedDB.databases){const e=await indexedDB.databases();if(Array.isArray(e))for(const t of e){const e=t?.name;e&&(await new Promise(t=>{const a=indexedDB.deleteDatabase(e);a.onsuccess=a.onerror=a.onblocked=()=>t()}),a.indexedDB.deletedNames.push(e))}}else{const e=["localforage","keyval-store","idb-keyval","app-db","threejs-cache"];for(const t of e)await new Promise(e=>{const a=indexedDB.deleteDatabase(t);a.onsuccess=a.onerror=a.onblocked=()=>e()});a.indexedDB.deletedNames=e}}catch(e){a.indexedDB.error=String(e)}try{if("undefined"!=typeof caches&&caches?.keys){const e=await caches.keys();for(const t of e){await caches.delete(t)&&a.caches.deletedKeys.push(t)}}}catch(e){a.caches.error=String(e)}return t&&location.reload(),a}CameraFly.setLookTarget(DEFAULT_ATTRACTOR?.dot||null),function(){if(!gui)return;const e=gui.addFolder("Storage");e.add({"Erase / Reset…":async function(){if(!confirm("This will remove saved app data.\n\nYou can choose:\n• KEY — remove only this app save (recommended)\n• ALL — clear ALL localStorage keys\n\nProceed?"))return;const e=(prompt("Type:\n  ALL  → clear ALL localStorage keys\n  KEY  → remove only this app save\n\nEnter your choice:","KEY")||"").trim().toUpperCase();if("ALL"!==e&&"KEY"!==e)return void alert("Cancelled: unknown choice. Use ALL or KEY.");const t="ALL"===e,a=await eraseAppData({clearAllLocalStorage:t,reload:!1}),n=["Cleanup complete.","","LocalStorage: "+(t?"CLEARED ALL KEYS":`Removed [${a.localStorage.removedKeys.join(", ")||"none"}]`),`LocalStorage count: ${a.localStorage.before} → ${a.localStorage.after}`,`IndexedDB deleted: ${a.indexedDB.deletedNames.length?a.indexedDB.deletedNames.join(", "):"none"}`,`Caches deleted: ${a.caches.deletedKeys.length?a.caches.deletedKeys.join(", "):"none"}`];alert(n.join("\n")),confirm("Reload now to apply a fully clean state?")&&location.reload()}},"Erase / Reset…").name("Erase / Reset…"),e.open()}();let last=performance.now(),audioVisibilityLevel=0,__loggedVideoWarn=!1;function tick(e=performance.now()){const t=(e-last)/1e3;last=e,shared.uTime.value+=t;const a="none"===source.type,n=sphereMat.uniforms.uUseTex&&0===sphereMat.uniforms.uUseTex.value,r=a&&n?1:0,o=.35*shared.uTime.value;sphereMat.uniforms.uRainbowOn&&(sphereMat.uniforms.uRainbowOn.value=r,sphereMat.uniforms.uRainbowRot.value=o),reflectMatBottom.uniforms.uRainbowOn&&(reflectMatBottom.uniforms.uRainbowOn.value=r,reflectMatBottom.uniforms.uRainbowRot.value=o),reflectMatTop.uniforms.uRainbowOn&&(reflectMatTop.uniforms.uRainbowOn.value=r,reflectMatTop.uniforms.uRainbowRot.value=o),spherePointsMat.uniforms.uRainbowOn&&(spherePointsMat.uniforms.uRainbowOn.value=r,spherePointsMat.uniforms.uRainbowRot.value=o),particlesOnFrame(t),updateAttractors(t),Starfield.update(t);const s=t*params.rotationSpeed;if(sphere.rotation.y+=s,mirrorBottom.rotation.y=sphere.rotation.y,mirrorTop.rotation.y=sphere.rotation.y,spherePoints.rotation.y=sphere.rotation.y,analyser&&freqData&&analyser.getByteFrequencyData(freqData),"audio"===source.type&&drawSpectrumTexture(),updateProbe(),pointsField){const e=pGeo.getAttribute("position"),a=pGeo.getAttribute("seed"),n=params.particleSpeedScale,r=params.particlePushStrength,o=params.particleMargin,s=params.particleDamping,i=params.particleSwirl;for(let l=0;l<P_COUNT;l++){const c=3*l,u=e.array[c],d=e.array[c+1],p=e.array[c+2];tmp.set(u,d,p).sub(center);const m=tmp.length();if(m>1e-4){const e=tmp.multiplyScalar(1/m),s=displacedRadiusAtDir(e,shared.uTime.value)+o;if(m<s){const a=(s-m)*r;vel[c]+=e.x*a*t,vel[c+1]+=e.y*a*t*.4,vel[c+2]+=e.z*a*t}const u=(new THREE.Vector3).crossVectors(e,up).normalize();vel[c]+=u.x*i*t,vel[c+1]+=u.y*i*t*.25,vel[c+2]+=u.z*i*t;const d=a.getY(l),p=a.getZ(l)+t*d*n;a.setZ(l,p),vel[c]+=.08*Math.cos(1.3*p)*t,vel[c+2]+=.08*Math.sin(1.1*p)*t}e.array[c]+=vel[c]*t,e.array[c+1]+=vel[c+1]*t,e.array[c+2]+=vel[c+2]*t,vel[c]*=s,vel[c+1]*=s,vel[c+2]*=s}e.needsUpdate=!0,a.needsUpdate=!0}let i=0;if(analyser&&freqData){let e=0,t=0;for(let a=8;a<64;a++)e+=freqData[a],t++;i=e/Math.max(1,t)/255;const a=specGeo.getAttribute("position"),n=specGeo.getAttribute("aColor"),r=params.spectrumRadius;specMat.uniforms.uSize.value=params.spectrumSize;for(let e=0;e<128;e++){const t=e/128*Math.PI*2,o=3*e,s=(freqData[e]||0)/255,i=.5*s*params.spectrumGain,l=s*params.spectrumHeight,c=r+i;a.array[o+0]=Math.cos(t)*c,a.array[o+1]=1.15+l,a.array[o+2]=Math.sin(t)*c;const u=(e/128+params.spectrumHueShift)%1,[d,p,m]=hslToRgb(u,1,THREE.MathUtils.clamp(.35+.5*s,0,1));n.array[o+0]=d,n.array[o+1]=p,n.array[o+2]=m,specPosLine[o+0]=a.array[o+0],specPosLine[o+1]=a.array[o+1],specPosLine[o+2]=a.array[o+2],specColLine[o+0]=d,specColLine[o+1]=p,specColLine[o+2]=m}a.needsUpdate=!0,n.needsUpdate=!0,specGeoLine.getAttribute("position").needsUpdate=!0,specGeoLine.getAttribute("color").needsUpdate=!0}if(params.autoShowBands){audioVisibilityLevel=audioVisibilityLevel*params.showSmoothing+i*(1-params.showSmoothing);const e=audioVisibilityLevel>params.showThreshold;spectrumPoints.visible=e&&"points"===params.spectrumMode,spectrumLine.visible=e&&"line"===params.spectrumMode}const l=params.pointSize,c=params.pcAudioReact?1+params.pcReactAmount*i:1;spherePointsMat.uniforms.uPointSize.value=l*c,"webcam"===source.type&&source.tex?source.tex.needsUpdate=!0:"video"===source.type&&(source.videoEl&&videoHasFrame(source.videoEl)?source.tex&&(source.tex.needsUpdate=!0):__loggedVideoWarn||(__loggedVideoWarn=!0)),CameraFly.update(t),controls&&controls.update(),renderer.render(scene,camera),requestAnimationFrame(tick)}function hideOverlay(){const e=document.querySelector(".ui-overlay");e&&(e.style.display="none",e.setAttribute("aria-hidden","true"))}async function beginFrom(e){if(await ensureAudioCtx(),audioCtx&&"suspended"===audioCtx.state)try{await audioCtx.resume()}catch{}hideOverlay(),"manual"===e&&playlist.length&&loadPlaylistIndex(currentIndex)}tick(),document.getElementById("overlayCTA")?.addEventListener("click",()=>beginFrom("manual"));const searchToggle=document.getElementById("searchToggle"),searchPanel=document.getElementById("searchPanel"),searchInput=document.getElementById("searchInput"),searchResults=document.getElementById("searchResults");function openSearch(){searchPanel.classList.remove("hidden"),searchInput.value="",renderSearchResults(playlist),searchInput.focus()}function closeSearch(){searchPanel.classList.add("hidden"),searchInput.blur()}function renderSearchResults(e){searchResults.innerHTML="";const t=document.createDocumentFragment();for(let a=0;a<Math.min(e.length,500);a++){const n=e[a],r=document.createElement("li");r.dataset.ix=String(n.__ix??a);const o=document.createElement("span");o.className="badge",o.textContent=n.type;const s=document.createElement("span");s.className="label",s.textContent=n.label,r.appendChild(o),r.appendChild(s),r.addEventListener("click",async()=>{const e=parseInt(r.dataset.ix,10);currentIndex=e,refreshPlaylistSelect(),await loadPlaylistIndex(e),closeSearch()}),t.appendChild(r)}searchResults.appendChild(t)}let _searchTimer=0;function doFilter(e){const t=e.trim().toLowerCase();if(!t)return void renderSearchResults(playlist.map((e,t)=>Object.assign({__ix:t},e)));const a=[];for(let e=0;e<playlist.length;e++){const n=playlist[e];(n.label||"").toLowerCase().includes(t)&&a.push(Object.assign({__ix:e},n))}renderSearchResults(a)}function debounceFilter(){clearTimeout(_searchTimer),_searchTimer=setTimeout(()=>doFilter(searchInput.value),120)}searchToggle.addEventListener("click",()=>{searchPanel.classList.contains("hidden")?openSearch():closeSearch()}),searchInput.addEventListener("input",debounceFilter),document.addEventListener("keydown",e=>{if("/"!==e.key||e.ctrlKey||e.metaKey||e.altKey){if("Escape"===e.key)searchPanel.classList.contains("hidden")||closeSearch();else if("Enter"===e.key&&!searchPanel.classList.contains("hidden")){const e=searchResults.querySelector("li");e&&e.click()}}else e.preventDefault(),openSearch()});const _origRefresh=refreshPlaylistSelect;refreshPlaylistSelect=function(){_origRefresh(),searchPanel.classList.contains("hidden")||doFilter(searchInput.value)},function(){const e=document.getElementById("uiToggleBtn");e&&e.addEventListener("click",function(){const e={key:"Escape",code:"Escape",keyCode:27,which:27,bubbles:!0,cancelable:!0};document.dispatchEvent(new KeyboardEvent("keydown",e)),window.dispatchEvent(new KeyboardEvent("keydown",e)),document.dispatchEvent(new KeyboardEvent("keyup",e)),window.dispatchEvent(new KeyboardEvent("keyup",e))},{passive:!0})}();const helpBtn=document.getElementById("helpBtn"),helpModal=document.getElementById("shortcutsModal"),helpClose=document.getElementById("helpClose");function openShortcuts(){helpModal&&helpModal.classList.remove("hidden")}function closeShortcuts(){helpModal&&helpModal.classList.add("hidden")}function toggleShortcuts(){helpModal&&helpModal.classList.toggle("hidden")}helpBtn?.addEventListener("click",toggleShortcuts),helpClose?.addEventListener("click",closeShortcuts),helpModal?.addEventListener("click",e=>{e.target===helpModal&&closeShortcuts()}),document.addEventListener("keydown",e=>{const t=e.key||e.code||"",a=helpModal&&!helpModal.classList.contains("hidden");if(!a&&("?"===t||"/"===t&&e.shiftKey)){const t=e.target,a=t?.tagName?.toUpperCase?.()||"";if(t?.isContentEditable||"INPUT"===a||"TEXTAREA"===a||"SELECT"===a)return;return e.preventDefault(),void toggleShortcuts()}if(a&&"Escape"===t)return e.preventDefault(),e.stopImmediatePropagation(),void closeShortcuts();a&&e.stopImmediatePropagation()}),function(){const e=document.documentElement,t=document.getElementById("themeToggle"),a=t?t.querySelector("img"):null;function n(e){try{localStorage.setItem("theme",e)}catch{}}function r(){const t=e.getAttribute("data-theme");if("dark"===t||"light"===t)return t;return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function o(t){const r="dark"===t||"light"===t?t:"light";e.setAttribute("data-theme",r),n(r),a&&("dark"===r?(a.src="media/icons/sun.svg",a.alt="Light mode"):(a.src="media/icons/moon.svg",a.alt="Dark mode"))}const s=function(){try{return localStorage.getItem("theme")}catch{return null}}();s||(e.setAttribute("data-theme","dark"),n("dark")),o(s||r()),t&&(t.onclick=()=>{o("dark"===r()?"light":"dark")})}();